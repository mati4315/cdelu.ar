<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administraci√≥n de Loter√≠as - CdelU</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        .lottery-card {
            transition: transform 0.2s;
            border: 1px solid #e0e0e0;
        }
        .lottery-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .status-badge {
            font-size: 0.8rem;
        }
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .btn-lottery {
            border-radius: 20px;
            font-weight: 500;
        }
        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .form-control:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
        .navbar-brand {
            font-weight: bold;
            color: #667eea !important;
        }
        .sidebar {
            min-height: 100vh;
            background: #f8f9fa;
        }
        .content-area {
            min-height: 100vh;
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="fas fa-dice"></i> CdelU Loter√≠as
            </a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text me-3" id="userInfo">
                    <i class="fas fa-user"></i> <span id="username">Cargando...</span>
                </span>
                <button class="btn btn-outline-light btn-sm" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Salir
                </button>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-3 col-lg-2 sidebar p-3">
                <div class="d-flex flex-column">
                    <button class="btn btn-primary btn-lottery mb-2" onclick="showCreateLotteryModal()">
                        <i class="fas fa-plus"></i> Nueva Loter√≠a
                    </button>
                    <hr>
                    <h6 class="text-muted">Filtros</h6>
                    <select class="form-select mb-2" id="statusFilter">
                        <option value="">Todos los estados</option>
                        <option value="draft">Borrador</option>
                        <option value="active">Activa</option>
                        <option value="closed">Cerrada</option>
                        <option value="finished">Finalizada</option>
                        <option value="cancelled">Cancelada</option>
                    </select>
                    <select class="form-select mb-2" id="typeFilter">
                        <option value="">Todos los tipos</option>
                        <option value="true">Gratuitas</option>
                        <option value="false">De pago</option>
                    </select>
                    <hr>
                    <h6 class="text-muted">Acciones</h6>
                    <button class="btn btn-outline-secondary btn-sm mb-1" onclick="refreshLotteries()">
                        <i class="fas fa-sync"></i> Actualizar
                    </button>
                    <button class="btn btn-outline-info btn-sm mb-1" onclick="checkOverdueLotteries()">
                        <i class="fas fa-clock"></i> Verificar Vencidas
                    </button>
                </div>
            </div>

            <!-- Main Content -->
            <div class="col-md-9 col-lg-10 content-area p-4">
                <!-- Stats Cards -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card stats-card">
                            <div class="card-body text-center">
                                <h5><i class="fas fa-ticket-alt"></i></h5>
                                <h4 id="totalLotteries">0</h4>
                                <small>Total Loter√≠as</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stats-card">
                            <div class="card-body text-center">
                                <h5><i class="fas fa-play"></i></h5>
                                <h4 id="activeLotteries">0</h4>
                                <small>Activas</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stats-card">
                            <div class="card-body text-center">
                                <h5><i class="fas fa-trophy"></i></h5>
                                <h4 id="finishedLotteries">0</h4>
                                <small>Finalizadas</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stats-card">
                            <div class="card-body text-center">
                                <h5><i class="fas fa-users"></i></h5>
                                <h4 id="totalParticipants">0</h4>
                                <small>Participantes</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Lotteries List -->
                <div class="row" id="lotteriesContainer">
                    <!-- Las loter√≠as se cargar√°n aqu√≠ din√°micamente -->
                </div>

                <!-- Pagination -->
                <nav aria-label="Paginaci√≥n de loter√≠as" class="mt-4">
                    <ul class="pagination justify-content-center" id="pagination">
                        <!-- Paginaci√≥n se generar√° din√°micamente -->
                    </ul>
                </nav>
            </div>
        </div>
    </div>

    <!-- Modal para crear/editar loter√≠a -->
    <div class="modal fade" id="lotteryModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="lotteryModalTitle">Nueva Loter√≠a</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="lotteryForm">
                        <div class="row">
                            <div class="col-md-8">
                                <div class="mb-3">
                                    <label for="title" class="form-label">T√≠tulo *</label>
                                    <input type="text" class="form-control" id="title" required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="is_free" class="form-label">Tipo</label>
                                    <select class="form-select" id="is_free">
                                        <option value="true" selected>Gratuita</option>
                                        <option value="false">De pago</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="description" class="form-label">Descripci√≥n</label>
                            <textarea class="form-control" id="description" rows="3"></textarea>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="min_tickets" class="form-label">Tickets m√≠nimos</label>
                                    <input type="number" class="form-control" id="min_tickets" value="1" min="1">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="max_tickets" class="form-label">Tickets m√°ximos *</label>
                                    <input type="number" class="form-control" id="max_tickets" required min="1" value="100">
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="num_winners" class="form-label">N√∫mero de ganadores</label>
                                    <input type="number" class="form-control" id="num_winners" value="1" min="1">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3" id="priceFieldContainer" style="display: none;">
                                    <label for="ticket_price" class="form-label">Precio por ticket *</label>
                                    <input type="number" class="form-control" id="ticket_price" value="100" min="100" step="0.01" required>
                                    <div class="form-text">M√≠nimo $100</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="start_date" class="form-label">Fecha de inicio *</label>
                                    <input type="datetime-local" class="form-control" id="start_date" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="end_date" class="form-label">Fecha de fin *</label>
                                    <input type="datetime-local" class="form-control" id="end_date" required>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="saveLottery()">Guardar Loter√≠a</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para ver detalles -->
    <div class="modal fade" id="detailsModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Detalles de Loter√≠a</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="detailsModalBody">
                    <!-- Contenido se cargar√° din√°micamente -->
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        // Configuraci√≥n global
        const API_BASE = '/api/v1/lotteries';
        let currentPage = 1;
        let currentLotteryId = null;

        // Verificar autenticaci√≥n al cargar
        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
            loadLotteries();
            updateStats();
        });

        // Verificar autenticaci√≥n
        async function checkAuth() {
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    window.location.href = '/login.html';
                    return;
                }

                const response = await axios.get('/api/v1/auth/me', {
                    headers: { Authorization: `Bearer ${token}` }
                });

                if (response.data.user.rol !== 'administrador') {
                    alert('Acceso denegado. Solo administradores pueden acceder.');
                    window.location.href = '/dashboard.html';
                    return;
                }

                document.getElementById('username').textContent = response.data.user.nombre;
            } catch (error) {
                console.error('Error de autenticaci√≥n:', error);
                window.location.href = '/login.html';
            }
        }

        // Cargar loter√≠as
        async function loadLotteries(page = 1) {
            try {
                const token = localStorage.getItem('token');
                const statusFilter = document.getElementById('statusFilter').value;
                const typeFilter = document.getElementById('typeFilter').value;

                let url = `${API_BASE}?page=${page}&limit=12`;
                if (statusFilter) url += `&status=${statusFilter}`;
                if (typeFilter) url += `&is_free=${typeFilter}`;

                const response = await axios.get(url, {
                    headers: { Authorization: `Bearer ${token}` }
                });

                displayLotteries(response.data.data);
                displayPagination(response.data.pagination);
                currentPage = page;
            } catch (error) {
                console.error('Error al cargar loter√≠as:', error);
                showAlert('Error al cargar las loter√≠as', 'danger');
            }
        }

        // Mostrar loter√≠as
        function displayLotteries(lotteries) {
            const container = document.getElementById('lotteriesContainer');
            container.innerHTML = '';

            if (lotteries.length === 0) {
                container.innerHTML = `
                    <div class="col-12 text-center py-5">
                        <i class="fas fa-ticket-alt fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">No hay loter√≠as disponibles</h5>
                        <p class="text-muted">Crea tu primera loter√≠a usando el bot√≥n "Nueva Loter√≠a"</p>
                    </div>
                `;
                return;
            }

            lotteries.forEach(lottery => {
                const card = createLotteryCard(lottery);
                container.appendChild(card);
            });
        }

        // Crear tarjeta de loter√≠a
        function createLotteryCard(lottery) {
            const col = document.createElement('div');
            col.className = 'col-md-6 col-lg-4 mb-4';
            
            const statusClass = getStatusClass(lottery.current_status || lottery.status);
            const isFree = lottery.is_free ? 'Gratuita' : 'De pago';
            const price = lottery.is_free ? 'Gratis' : `$${lottery.ticket_price}`;
            
            col.innerHTML = `
                <div class="card lottery-card h-100">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span class="badge ${statusClass} status-badge">${getStatusText(lottery.current_status || lottery.status)}</span>
                        <span class="badge bg-info status-badge">${isFree}</span>
                    </div>
                    <div class="card-body">
                        <h6 class="card-title">${lottery.title}</h6>
                        <p class="card-text text-muted small">${lottery.description || 'Sin descripci√≥n'}</p>
                        
                        <div class="row text-center mb-3">
                            <div class="col-6">
                                <small class="text-muted">Tickets vendidos</small>
                                <div class="fw-bold">${lottery.tickets_sold || 0}/${lottery.max_tickets}</div>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">Precio</small>
                                <div class="fw-bold">${price}</div>
                            </div>
                        </div>
                        
                        <div class="row text-center mb-3">
                            <div class="col-6">
                                <small class="text-muted">Ganadores</small>
                                <div class="fw-bold">${lottery.winners_selected || 0}/${lottery.num_winners}</div>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">Participaci√≥n</small>
                                <div class="fw-bold">${Math.round((lottery.tickets_sold || 0) / lottery.max_tickets * 100)}%</div>
                            </div>
                        </div>
                        
                        <hr>
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">
                                <i class="fas fa-calendar"></i> ${formatDate(lottery.end_date)}
                            </small>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary" onclick="viewDetails(${lottery.id})" title="Ver detalles">
                                    <i class="fas fa-eye"></i>
                                </button>
                                ${lottery.status === 'draft' ? `
                                    <button class="btn btn-outline-success" onclick="editLottery(${lottery.id})" title="Editar">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-outline-warning" onclick="activateLottery(${lottery.id})" title="Activar">
                                        <i class="fas fa-play"></i>
                                    </button>
                                    <button class="btn btn-outline-danger" onclick="deleteLottery(${lottery.id})" title="Eliminar">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                ` : ''}
                                ${lottery.status === 'active' ? `
                                    <button class="btn btn-outline-warning" onclick="finishLottery(${lottery.id})" title="Finalizar Loter√≠a">
                                        <i class="fas fa-trophy"></i>
                                    </button>
                                    <button class="btn btn-outline-success" onclick="editLottery(${lottery.id})" title="Editar">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-outline-danger" onclick="cancelLottery(${lottery.id})" title="Cancelar">
                                        <i class="fas fa-ban"></i>
                                    </button>
                                    <button class="btn btn-outline-dark" onclick="deleteLottery(${lottery.id})" title="Eliminar">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                ` : ''}
                                ${lottery.status === 'cancelled' ? `
                                    <button class="btn btn-outline-success" onclick="editLottery(${lottery.id})" title="Editar">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-outline-primary" onclick="resumeLottery(${lottery.id})" title="Reanudar">
                                        <i class="fas fa-play-circle"></i>
                                    </button>
                                    <button class="btn btn-outline-danger" onclick="deleteLottery(${lottery.id})" title="Eliminar">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                ` : ''}
                                ${lottery.current_status === 'overdue' ? `
                                    <button class="btn btn-outline-danger" onclick="finishLottery(${lottery.id})" title="Finalizar (Vencida)">
                                        <i class="fas fa-trophy"></i>
                                    </button>
                                    <button class="btn btn-outline-dark" onclick="deleteLottery(${lottery.id})" title="Eliminar">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                ` : ''}
                                ${lottery.status === 'finished' ? `
                                    <button class="btn btn-outline-dark" onclick="deleteLottery(${lottery.id})" title="Eliminar">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            return col;
        }

        // Mostrar paginaci√≥n
        function displayPagination(pagination) {
            const container = document.getElementById('pagination');
            container.innerHTML = '';

            if (pagination.pages <= 1) return;

            // Bot√≥n anterior
            const prevLi = document.createElement('li');
            prevLi.className = `page-item ${pagination.page <= 1 ? 'disabled' : ''}`;
            prevLi.innerHTML = `<a class="page-link" href="#" onclick="loadLotteries(${pagination.page - 1})">Anterior</a>`;
            container.appendChild(prevLi);

            // P√°ginas
            for (let i = 1; i <= pagination.pages; i++) {
                const li = document.createElement('li');
                li.className = `page-item ${i === pagination.page ? 'active' : ''}`;
                li.innerHTML = `<a class="page-link" href="#" onclick="loadLotteries(${i})">${i}</a>`;
                container.appendChild(li);
            }

            // Bot√≥n siguiente
            const nextLi = document.createElement('li');
            nextLi.className = `page-item ${pagination.page >= pagination.pages ? 'disabled' : ''}`;
            nextLi.innerHTML = `<a class="page-link" href="#" onclick="loadLotteries(${pagination.page + 1})">Siguiente</a>`;
            container.appendChild(nextLi);
        }

        // Actualizar estad√≠sticas
        async function updateStats() {
            try {
                const token = localStorage.getItem('token');
                const response = await axios.get(`${API_BASE}?limit=100`, {
                    headers: { Authorization: `Bearer ${token}` }
                });

                const lotteries = response.data.data;
                const stats = {
                    total: lotteries.length,
                    active: lotteries.filter(l => l.current_status === 'running').length,
                    finished: lotteries.filter(l => l.status === 'finished').length,
                    participants: lotteries.reduce((sum, l) => sum + (l.tickets_sold || 0), 0)
                };

                document.getElementById('totalLotteries').textContent = stats.total;
                document.getElementById('activeLotteries').textContent = stats.active;
                document.getElementById('finishedLotteries').textContent = stats.finished;
                document.getElementById('totalParticipants').textContent = stats.participants;
            } catch (error) {
                console.error('Error al actualizar estad√≠sticas:', error);
            }
        }

        // Mostrar modal de crear loter√≠a
        function showCreateLotteryModal() {
            currentLotteryId = null;
            document.getElementById('lotteryModalTitle').textContent = 'Nueva Loter√≠a';
            document.getElementById('lotteryForm').reset();
            
            // Establecer fechas por defecto
            const now = new Date();
            const tomorrow = new Date(now.getTime() + 24 * 60 * 60 * 1000);
            const nextWeek = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000);
            
            document.getElementById('start_date').value = formatDateTimeLocal(now);
            document.getElementById('end_date').value = formatDateTimeLocal(nextWeek);
            
            // Configurar campo de precio seg√∫n tipo de loter√≠a
            setupPriceField();
            
            new bootstrap.Modal(document.getElementById('lotteryModal')).show();
        }

        // Guardar loter√≠a
        async function saveLottery() {
            try {
                const formData = getFormData();
                const token = localStorage.getItem('token');
                
                const url = currentLotteryId ? `${API_BASE}/${currentLotteryId}` : API_BASE;
                const method = currentLotteryId ? 'put' : 'post';
                
                const response = await axios[method](url, formData, {
                    headers: { Authorization: `Bearer ${token}` }
                });

                showAlert('Loter√≠a guardada exitosamente', 'success');
                closeModal('lotteryModal');
                loadLotteries(currentPage);
                updateStats();
            } catch (error) {
                console.error('Error al guardar loter√≠a:', error);
                showAlert('Error al guardar la loter√≠a', 'danger');
            }
        }

        // Obtener datos del formulario
        function getFormData() {
            // Convertir fechas al formato ISO correcto
            const startDate = document.getElementById('start_date').value;
            const endDate = document.getElementById('end_date').value;
            
            return {
                title: document.getElementById('title').value,
                description: document.getElementById('description').value,
                is_free: document.getElementById('is_free').value === 'true',
                ticket_price: parseFloat(document.getElementById('ticket_price').value),
                min_tickets: parseInt(document.getElementById('min_tickets').value),
                max_tickets: parseInt(document.getElementById('max_tickets').value),
                num_winners: parseInt(document.getElementById('num_winners').value),
                start_date: startDate ? new Date(startDate).toISOString() : null,
                end_date: endDate ? new Date(endDate).toISOString() : null,
                prize_description: '', // Campo eliminado
                terms_conditions: '' // Campo eliminado
            };
        }

        // Ver detalles de loter√≠a
        async function viewDetails(lotteryId) {
            try {
                const token = localStorage.getItem('token');
                const response = await axios.get(`${API_BASE}/${lotteryId}`, {
                    headers: { Authorization: `Bearer ${token}` }
                });

                const lottery = response.data.data;
                const modalBody = document.getElementById('detailsModalBody');
                
                modalBody.innerHTML = `
                    <div class="row">
                        <div class="col-md-8">
                            <h5>${lottery.title}</h5>
                            <p class="text-muted">${lottery.description || 'Sin descripci√≥n'}</p>
                            
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <strong>Tipo:</strong> ${lottery.is_free ? 'Gratuita' : 'De pago'}<br>
                                    <strong>Precio:</strong> ${lottery.is_free ? 'Gratis' : `$${lottery.ticket_price}`}<br>
                                    <strong>Estado:</strong> <span class="badge ${getStatusClass(lottery.current_status || lottery.status)}">${getStatusText(lottery.current_status || lottery.status)}</span>
                                </div>
                                <div class="col-md-6">
                                    <strong>Tickets vendidos:</strong> ${lottery.tickets_sold || 0}/${lottery.max_tickets}<br>
                                    <strong>Ganadores:</strong> ${lottery.winners_selected || 0}/${lottery.num_winners}<br>
                                    <strong>Participaci√≥n:</strong> ${Math.round((lottery.tickets_sold || 0) / lottery.max_tickets * 100)}%
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <strong>Fecha de inicio:</strong><br>
                                    ${formatDate(lottery.start_date)}
                                </div>
                                <div class="col-md-6">
                                    <strong>Fecha de fin:</strong><br>
                                    ${formatDate(lottery.end_date)}
                                </div>
                            </div>
                            
                            ${lottery.prize_description ? `
                                <div class="mb-3">
                                    <strong>Premio:</strong><br>
                                    ${lottery.prize_description}
                                </div>
                            ` : ''}
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0">Acciones</h6>
                                </div>
                                <div class="card-body">
                                    ${lottery.status === 'draft' ? `
                                        <button class="btn btn-success btn-sm w-100 mb-2" onclick="activateLottery(${lottery.id})">
                                            <i class="fas fa-play"></i> Activar
                                        </button>
                                    ` : ''}
                                    ${lottery.status === 'active' ? `
                                        <button class="btn btn-warning btn-sm w-100 mb-2" onclick="finishLottery(${lottery.id})">
                                            <i class="fas fa-trophy"></i> Finalizar Loter√≠a
                                        </button>
                                        <button class="btn btn-outline-danger btn-sm w-100 mb-2" onclick="cancelLottery(${lottery.id})">
                                            <i class="fas fa-ban"></i> Cancelar
                                        </button>
                                    ` : ''}
                                    ${lottery.current_status === 'overdue' ? `
                                        <button class="btn btn-danger btn-sm w-100 mb-2" onclick="finishLottery(${lottery.id})">
                                            <i class="fas fa-trophy"></i> Finalizar (Vencida)
                                        </button>
                                    ` : ''}
                                    <button class="btn btn-info btn-sm w-100 mb-2" onclick="viewWinners(${lottery.id})">
                                        <i class="fas fa-trophy"></i> Ver Ganadores
                                    </button>
                                    <button class="btn btn-secondary btn-sm w-100" onclick="generateReport(${lottery.id})">
                                        <i class="fas fa-chart-bar"></i> Reporte
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                new bootstrap.Modal(document.getElementById('detailsModal')).show();
            } catch (error) {
                console.error('Error al cargar detalles:', error);
                showAlert('Error al cargar los detalles', 'danger');
            }
        }

        // Activar loter√≠a
        async function activateLottery(lotteryId) {
            if (!confirm('¬øEst√°s seguro de que quieres activar esta loter√≠a?')) return;
            
            try {
                const token = localStorage.getItem('token');
                await axios.put(`${API_BASE}/${lotteryId}`, {
                    status: 'active'
                }, {
                    headers: { Authorization: `Bearer ${token}` }
                });

                showAlert('Loter√≠a activada exitosamente', 'success');
                loadLotteries(currentPage);
                updateStats();
            } catch (error) {
                console.error('Error al activar loter√≠a:', error);
                showAlert('Error al activar la loter√≠a', 'danger');
            }
        }

        // Finalizar loter√≠a
        async function finishLottery(lotteryId, force = false) {
            try {
                const token = localStorage.getItem('token');
                
                // Obtener informaci√≥n de la loter√≠a
                const lotteryResponse = await axios.get(`${API_BASE}/${lotteryId}`, {
                    headers: { Authorization: `Bearer ${token}` }
                });
                
                const lottery = lotteryResponse.data.data;
                const now = new Date();
                const endDate = new Date(lottery.end_date);
                const hasEnded = now >= endDate;
                
                // Si no es forzado, verificar condiciones
                if (!force) {
                    if (!hasEnded) {
                        const minutesLeft = Math.ceil((endDate - now) / (1000 * 60));
                        const forceConfirm = confirm(`‚ö†Ô∏è ADVERTENCIA: Esta loter√≠a a√∫n no ha terminado.
                        
Faltan ${minutesLeft} minutos para que termine oficialmente.
Fecha fin: ${endDate.toLocaleString()}

¬øQuieres forzar la finalizaci√≥n de todas formas?`);
                        if (!forceConfirm) return;
                        force = true;
                    } else if (lottery.tickets_sold === 0) {
                        const confirmEmpty = confirm(`‚ö†Ô∏è ADVERTENCIA: Esta loter√≠a no tiene participantes.
                        
‚Ä¢ Tickets vendidos: 0
‚Ä¢ M√≠nimo requerido: ${lottery.min_tickets}

Al finalizar, la loter√≠a ser√° cancelada autom√°ticamente.

¬øDeseas continuar?`);
                        if (!confirmEmpty) return;
                    }
                }
                
                // Mostrar opciones de finalizaci√≥n
                showFinishOptionsModal(lotteryId, lottery, force);
                
            } catch (error) {
                console.error('Error al finalizar loter√≠a:', error);
                
                if (error.response?.status === 400) {
                    const errorData = error.response.data;
                    
                    // Si el error es por tiempo, ofrecer forzar finalizaci√≥n
                    if (errorData.message?.includes('a√∫n no ha terminado')) {
                        const minutesLeft = errorData.data?.minutes_left || 'algunos';
                        const forceConfirm = confirm(`La loter√≠a a√∫n no ha terminado (faltan ${minutesLeft} minutos).

¬øQuieres forzar la finalizaci√≥n de todas formas?

‚ö†Ô∏è Esto finalizar√° la loter√≠a antes de tiempo.`);
                        
                        if (forceConfirm) {
                            // Llamar recursivamente con force=true
                            return finishLottery(lotteryId, true);
                        }
                    } else {
                        showAlert(`Error: ${errorData.message}`, 'danger');
                    }
                } else {
                    showAlert(`Error al finalizar la loter√≠a: ${error.response?.data?.message || error.message}`, 'danger');
                }
            }
        }

        // Mostrar modal de opciones de finalizaci√≥n
        function showFinishOptionsModal(lotteryId, lottery, force = false) {
            // Crear modal de opciones
            const modalHtml = `
                <div class="modal fade" id="finishOptionsModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header bg-warning text-dark">
                                <h5 class="modal-title">
                                    <i class="fas fa-trophy"></i> 
                                    Finalizar Loter√≠a: ${lottery.title}
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="mb-4">
                                    <h6 class="fw-bold">üìä Informaci√≥n de la Loter√≠a:</h6>
                                    <ul class="list-unstyled">
                                        <li><strong>Tickets vendidos:</strong> ${lottery.tickets_sold || 0}</li>
                                        <li><strong>Ganadores a seleccionar:</strong> ${lottery.num_winners}</li>
                                        <li><strong>Estado:</strong> ${lottery.status}</li>
                                        <li><strong>Fecha fin:</strong> ${formatDate(lottery.end_date)}</li>
                                    </ul>
                                </div>
                                
                                <div class="mb-4">
                                    <h6 class="fw-bold">üéØ Selecciona el m√©todo de finalizaci√≥n:</h6>
                                    
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <div class="card h-100 border-primary">
                                                <div class="card-body text-center">
                                                    <i class="fas fa-hand-pointer fa-3x text-primary mb-3"></i>
                                                    <h6 class="card-title">Selecci√≥n Manual</h6>
                                                    <p class="card-text small">T√∫ elegir√°s los n√∫meros ganadores manualmente</p>
                                                    <button class="btn btn-primary btn-sm" onclick="selectManualFinish(${lotteryId}, ${force})">
                                                        <i class="fas fa-hand-pointer"></i> Elegir Manualmente
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="col-md-6 mb-3">
                                            <div class="card h-100 border-success">
                                                <div class="card-body text-center">
                                                    <i class="fas fa-random fa-3x text-success mb-3"></i>
                                                    <h6 class="card-title">Selecci√≥n Autom√°tica</h6>
                                                    <p class="card-text small">El sistema seleccionar√° los ganadores al azar</p>
                                                    <button class="btn btn-success btn-sm" onclick="selectAutomaticFinish(${lotteryId}, ${force})">
                                                        <i class="fas fa-random"></i> Selecci√≥n Autom√°tica
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle"></i> 
                                    <strong>Nota:</strong> Una vez finalizada la loter√≠a, no se podr√°n realizar m√°s cambios.
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                    <i class="fas fa-times"></i> Cancelar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remover modal existente si hay uno
            const existingModal = document.getElementById('finishOptionsModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Agregar modal al DOM
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // Mostrar modal
            const modal = new bootstrap.Modal(document.getElementById('finishOptionsModal'));
            modal.show();
        }

        // Seleccionar finalizaci√≥n manual
        async function selectManualFinish(lotteryId, force = false) {
            try {
                const token = localStorage.getItem('token');
                
                // Obtener tickets vendidos
                const ticketsResponse = await axios.get(`${API_BASE}/${lotteryId}/sold-tickets`, {
                    headers: { Authorization: `Bearer ${token}` }
                });
                
                const soldTickets = ticketsResponse.data.data.ticket_numbers;
                
                if (soldTickets.length === 0) {
                    showAlert('No hay tickets vendidos para esta loter√≠a', 'warning');
                    closeModal('finishOptionsModal');
                    return;
                }
                
                // Cerrar modal de opciones
                closeModal('finishOptionsModal');
                
                // Mostrar modal de selecci√≥n manual
                showManualSelectionModal(lotteryId, force, soldTickets);
                
            } catch (error) {
                console.error('Error al cargar tickets para selecci√≥n manual:', error);
                showAlert('Error al cargar los tickets vendidos', 'danger');
            }
        }

        // Seleccionar finalizaci√≥n autom√°tica
        async function selectAutomaticFinish(lotteryId, force = false) {
            try {
                // Obtener informaci√≥n de la loter√≠a
                const token = localStorage.getItem('token');
                const lotteryResponse = await axios.get(`${API_BASE}/${lotteryId}`, {
                    headers: { Authorization: `Bearer ${token}` }
                });
                
                const lottery = lotteryResponse.data.data;
                
                // Cerrar modal de opciones
                closeModal('finishOptionsModal');
                
                // Confirmar selecci√≥n autom√°tica
                const confirmAuto = confirm(`¬øConfirmas finalizar la loter√≠a con selecci√≥n autom√°tica de ganadores?

El sistema seleccionar√° ${lottery.num_winners} ganador${lottery.num_winners > 1 ? 'es' : ''} al azar entre todos los tickets vendidos.

¬øDeseas continuar?`);
                
                if (confirmAuto) {
                    await performLotteryFinish(lotteryId, { 
                        force,
                        winner_selection_method: 'random',
                        winning_numbers: []
                    });
                }
            } catch (error) {
                console.error('Error al obtener informaci√≥n de la loter√≠a:', error);
                showAlert('Error al obtener informaci√≥n de la loter√≠a', 'danger');
            }
        }

        // Mostrar modal de selecci√≥n manual
        function showManualSelectionModal(lotteryId, force, soldTickets) {
            // Obtener informaci√≥n de la loter√≠a para mostrar en el modal
            axios.get(`${API_BASE}/${lotteryId}`, {
                headers: { Authorization: `Bearer ${localStorage.getItem('token')}` }
            }).then(response => {
                const lottery = response.data.data;
                
                // Crear modal de selecci√≥n manual
                const modalHtml = `
                    <div class="modal fade" id="manualSelectionModal" tabindex="-1">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header bg-primary text-white">
                                    <h5 class="modal-title">
                                        <i class="fas fa-hand-pointer"></i> 
                                        Selecci√≥n Manual de Ganadores: ${lottery.title}
                                    </h5>
                                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="mb-4">
                                        <h6 class="fw-bold">üìä Informaci√≥n:</h6>
                                        <ul class="list-unstyled">
                                            <li><strong>Tickets vendidos:</strong> ${lottery.tickets_sold}</li>
                                            <li><strong>Ganadores a seleccionar:</strong> ${lottery.num_winners}</li>
                                            <li><strong>N√∫meros disponibles:</strong> ${soldTickets.length}</li>
                                        </ul>
                                    </div>
                                    
                                    <div class="mb-4">
                                        <h6 class="fw-bold">üé´ Selecciona los n√∫meros ganadores (${lottery.num_winners} ganador${lottery.num_winners > 1 ? 'es' : ''}):</h6>
                                        <div class="alert alert-info">
                                            <i class="fas fa-info-circle"></i> 
                                            Haz clic en los n√∫meros para seleccionar los ganadores. 
                                            Puedes seleccionar hasta ${lottery.num_winners} n√∫mero${lottery.num_winners > 1 ? 's' : ''}.
                                        </div>
                                        <div id="ticketNumbers" class="d-flex flex-wrap gap-2" style="max-height: 300px; overflow-y: auto;">
                                            ${soldTickets.map(num => `
                                                <button type="button" class="btn btn-outline-primary ticket-number-btn" data-number="${num}">
                                                    ${num}
                                                </button>
                                            `).join('')}
                                        </div>
                                        <div class="mt-3">
                                            <strong>N√∫meros seleccionados:</strong>
                                            <span id="selectedNumbers" class="text-primary">Ninguno</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                        <i class="fas fa-times"></i> Cancelar
                                    </button>
                                    <button type="button" class="btn btn-success" id="confirmManualFinishBtn">
                                        <i class="fas fa-trophy"></i> Finalizar con Selecci√≥n Manual
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Remover modal existente si hay uno
                const existingModal = document.getElementById('manualSelectionModal');
                if (existingModal) {
                    existingModal.remove();
                }
                
                // Agregar modal al DOM
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                
                // Configurar eventos del modal
                setupManualSelectionModal(lotteryId, lottery, force, soldTickets);
                
                // Mostrar modal
                const modal = new bootstrap.Modal(document.getElementById('manualSelectionModal'));
                modal.show();
                
            }).catch(error => {
                console.error('Error al cargar informaci√≥n de loter√≠a:', error);
                showAlert('Error al cargar informaci√≥n de la loter√≠a', 'danger');
            });
        }

        // Configurar eventos del modal de selecci√≥n manual
        function setupManualSelectionModal(lotteryId, lottery, force, soldTickets) {
            const modal = document.getElementById('manualSelectionModal');
            const confirmBtn = modal.querySelector('#confirmManualFinishBtn');
            const selectedNumbersSpan = modal.querySelector('#selectedNumbers');
            
            let selectedNumbers = [];
            
            // Funci√≥n para actualizar n√∫meros seleccionados
            function updateSelectedNumbers() {
                if (selectedNumbers.length === 0) {
                    selectedNumbersSpan.textContent = 'Ninguno';
                    selectedNumbersSpan.className = 'text-muted';
                } else {
                    selectedNumbersSpan.textContent = selectedNumbers.sort((a, b) => a - b).join(', ');
                    selectedNumbersSpan.className = 'text-primary fw-bold';
                }
                
                // Actualizar estado del bot√≥n confirmar
                const isValidSelection = selectedNumbers.length === lottery.num_winners;
                confirmBtn.disabled = !isValidSelection;
                
                if (selectedNumbers.length !== lottery.num_winners) {
                    confirmBtn.innerHTML = `
                        <i class="fas fa-exclamation-triangle"></i> 
                        Selecciona ${lottery.num_winners} n√∫mero${lottery.num_winners > 1 ? 's' : ''} 
                        (${selectedNumbers.length}/${lottery.num_winners})
                    `;
                } else {
                    confirmBtn.innerHTML = '<i class="fas fa-trophy"></i> Finalizar con Selecci√≥n Manual';
                }
            }
            
            // Event listeners para los botones de n√∫meros
            modal.querySelectorAll('.ticket-number-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const number = parseInt(btn.dataset.number);
                    
                    if (selectedNumbers.includes(number)) {
                        // Deseleccionar
                        selectedNumbers = selectedNumbers.filter(n => n !== number);
                        btn.classList.remove('btn-success');
                        btn.classList.add('btn-outline-primary');
                    } else {
                        // Seleccionar si no se ha alcanzado el l√≠mite
                        if (selectedNumbers.length < lottery.num_winners) {
                            selectedNumbers.push(number);
                            btn.classList.remove('btn-outline-primary');
                            btn.classList.add('btn-success');
                        } else {
                            showAlert(`Solo puedes seleccionar ${lottery.num_winners} ganador${lottery.num_winners > 1 ? 'es' : ''}`, 'warning');
                        }
                    }
                    
                    updateSelectedNumbers();
                });
            });
            
            // Confirmar finalizaci√≥n manual
            confirmBtn.addEventListener('click', async () => {
                // Cerrar modal
                const modalInstance = bootstrap.Modal.getInstance(modal);
                modalInstance.hide();
                
                // Finalizar loter√≠a con selecci√≥n manual
                await performLotteryFinish(lotteryId, { 
                    force,
                    winner_selection_method: 'manual',
                    winning_numbers: selectedNumbers
                });
            });
            
            // Inicializar estado
            updateSelectedNumbers();
        }

        // Mostrar modal de selecci√≥n de ganadores
        async function showWinnerSelectionModal(lotteryId, lottery, force = false) {
            try {
                const token = localStorage.getItem('token');
                
                // Obtener tickets vendidos
                const ticketsResponse = await axios.get(`${API_BASE}/${lotteryId}/sold-tickets`, {
                    headers: { Authorization: `Bearer ${token}` }
                });
                
                const soldTickets = ticketsResponse.data.data.ticket_numbers;
                
                if (soldTickets.length === 0) {
                    showAlert('No hay tickets vendidos para esta loter√≠a', 'warning');
                    return;
                }
                
                // Crear modal de selecci√≥n
                const modalHtml = `
                    <div class="modal fade" id="winnerSelectionModal" tabindex="-1">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">
                                        <i class="fas fa-trophy"></i> 
                                        Finalizar Loter√≠a: ${lottery.title}
                                    </h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="mb-4">
                                        <h6 class="fw-bold">üìä Informaci√≥n de la Loter√≠a:</h6>
                                        <ul class="list-unstyled">
                                            <li><strong>Tickets vendidos:</strong> ${lottery.tickets_sold}</li>
                                            <li><strong>Ganadores a seleccionar:</strong> ${lottery.num_winners}</li>
                                            <li><strong>Estado:</strong> ${lottery.status}</li>
                                        </ul>
                                    </div>
                                    
                                    <div class="mb-4">
                                        <h6 class="fw-bold">üéØ M√©todo de Selecci√≥n:</h6>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="radio" name="selectionMethod" id="randomSelection" value="random" checked>
                                            <label class="form-check-label" for="randomSelection">
                                                <i class="fas fa-random"></i> <strong>Selecci√≥n Aleatoria</strong>
                                                <small class="text-muted d-block">El sistema seleccionar√° los ganadores al azar</small>
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="selectionMethod" id="manualSelection" value="manual">
                                            <label class="form-check-label" for="manualSelection">
                                                <i class="fas fa-hand-pointer"></i> <strong>Selecci√≥n Manual</strong>
                                                <small class="text-muted d-block">T√∫ elegir√°s los n√∫meros ganadores</small>
                                            </label>
                                        </div>
                                    </div>
                                    
                                    <div id="manualSelectionArea" class="mb-4" style="display: none;">
                                        <h6 class="fw-bold">üé´ Seleccionar N√∫meros Ganadores (${lottery.num_winners} ganador${lottery.num_winners > 1 ? 'es' : ''}):</h6>
                                        <div class="alert alert-info">
                                            <i class="fas fa-info-circle"></i> 
                                            Haz clic en los n√∫meros para seleccionar los ganadores. 
                                            Puedes seleccionar hasta ${lottery.num_winners} n√∫mero${lottery.num_winners > 1 ? 's' : ''}.
                                        </div>
                                        <div id="ticketNumbers" class="d-flex flex-wrap gap-2">
                                            ${soldTickets.map(num => `
                                                <button type="button" class="btn btn-outline-primary ticket-number-btn" data-number="${num}">
                                                    ${num}
                                                </button>
                                            `).join('')}
                                        </div>
                                        <div class="mt-3">
                                            <strong>N√∫meros seleccionados:</strong>
                                            <span id="selectedNumbers" class="text-primary">Ninguno</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                        <i class="fas fa-times"></i> Cancelar
                                    </button>
                                    <button type="button" class="btn btn-success" id="confirmFinishBtn">
                                        <i class="fas fa-trophy"></i> Finalizar Loter√≠a
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Remover modal existente si hay uno
                const existingModal = document.getElementById('winnerSelectionModal');
                if (existingModal) {
                    existingModal.remove();
                }
                
                // Agregar modal al DOM
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                
                // Configurar eventos del modal
                setupWinnerSelectionModal(lotteryId, lottery, force, soldTickets);
                
                // Mostrar modal
                const modal = new bootstrap.Modal(document.getElementById('winnerSelectionModal'));
                modal.show();
                
            } catch (error) {
                console.error('Error mostrando modal de selecci√≥n:', error);
                showAlert('Error al cargar opciones de selecci√≥n de ganadores', 'danger');
            }
        }

        // Configurar eventos del modal de selecci√≥n
        function setupWinnerSelectionModal(lotteryId, lottery, force, soldTickets) {
            const modal = document.getElementById('winnerSelectionModal');
            const randomRadio = modal.querySelector('#randomSelection');
            const manualRadio = modal.querySelector('#manualSelection');
            const manualArea = modal.querySelector('#manualSelectionArea');
            const confirmBtn = modal.querySelector('#confirmFinishBtn');
            const selectedNumbersSpan = modal.querySelector('#selectedNumbers');
            
            let selectedNumbers = [];
            
            // Manejar cambio de m√©todo de selecci√≥n
            function handleSelectionMethodChange() {
                if (manualRadio.checked) {
                    manualArea.style.display = 'block';
                } else {
                    manualArea.style.display = 'none';
                    selectedNumbers = [];
                    updateSelectedNumbers();
                }
            }
            
            randomRadio.addEventListener('change', handleSelectionMethodChange);
            manualRadio.addEventListener('change', handleSelectionMethodChange);
            
            // Manejar selecci√≥n de n√∫meros
            function updateSelectedNumbers() {
                if (selectedNumbers.length === 0) {
                    selectedNumbersSpan.textContent = 'Ninguno';
                    selectedNumbersSpan.className = 'text-muted';
                } else {
                    selectedNumbersSpan.textContent = selectedNumbers.sort((a, b) => a - b).join(', ');
                    selectedNumbersSpan.className = 'text-primary fw-bold';
                }
                
                // Actualizar estado del bot√≥n confirmar
                const isValidSelection = randomRadio.checked || selectedNumbers.length === lottery.num_winners;
                confirmBtn.disabled = !isValidSelection;
                
                if (manualRadio.checked && selectedNumbers.length !== lottery.num_winners) {
                    confirmBtn.innerHTML = `
                        <i class="fas fa-exclamation-triangle"></i> 
                        Selecciona ${lottery.num_winners} n√∫mero${lottery.num_winners > 1 ? 's' : ''} 
                        (${selectedNumbers.length}/${lottery.num_winners})
                    `;
                } else {
                    confirmBtn.innerHTML = '<i class="fas fa-trophy"></i> Finalizar Loter√≠a';
                }
            }
            
            // Event listeners para los botones de n√∫meros
            modal.querySelectorAll('.ticket-number-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const number = parseInt(btn.dataset.number);
                    
                    if (selectedNumbers.includes(number)) {
                        // Deseleccionar
                        selectedNumbers = selectedNumbers.filter(n => n !== number);
                        btn.classList.remove('btn-success');
                        btn.classList.add('btn-outline-primary');
                    } else {
                        // Seleccionar si no se ha alcanzado el l√≠mite
                        if (selectedNumbers.length < lottery.num_winners) {
                            selectedNumbers.push(number);
                            btn.classList.remove('btn-outline-primary');
                            btn.classList.add('btn-success');
                        } else {
                            showAlert(`Solo puedes seleccionar ${lottery.num_winners} ganador${lottery.num_winners > 1 ? 'es' : ''}`, 'warning');
                        }
                    }
                    
                    updateSelectedNumbers();
                });
            });
            
            // Confirmar finalizaci√≥n
            confirmBtn.addEventListener('click', async () => {
                const method = manualRadio.checked ? 'manual' : 'random';
                const winningNumbers = method === 'manual' ? selectedNumbers : [];
                
                // Cerrar modal
                const modalInstance = bootstrap.Modal.getInstance(modal);
                modalInstance.hide();
                
                // Finalizar loter√≠a
                await performLotteryFinish(lotteryId, { 
                    force,
                    winner_selection_method: method,
                    winning_numbers: winningNumbers
                });
            });
            
            // Inicializar estado
            updateSelectedNumbers();
        }

        // Realizar finalizaci√≥n de loter√≠a
        async function performLotteryFinish(lotteryId, params) {
            try {
                const token = localStorage.getItem('token');
                
                const response = await axios.post(`${API_BASE}/${lotteryId}/finish`, params, {
                    headers: { Authorization: `Bearer ${token}` }
                });

                if (response.data.data.status === 'cancelled') {
                    showAlert(`Loter√≠a cancelada: ${response.data.message}`, 'warning');
                } else {
                    const selectionText = params.winner_selection_method === 'manual' ? 'manualmente' : 'aleatoriamente';
                    showAlert(`¬°Loter√≠a finalizada exitosamente! Ganadores seleccionados ${selectionText}: ${response.data.data.winners_count}`, 'success');
                }
                
                loadLotteries(currentPage);
                updateStats();
                
            } catch (error) {
                console.error('Error al finalizar loter√≠a:', error);
                showAlert(`Error al finalizar la loter√≠a: ${error.response?.data?.message || error.message}`, 'danger');
            }
        }

        // Cancelar loter√≠a
        async function cancelLottery(lotteryId) {
            if (!confirm('¬øEst√°s seguro de que quieres cancelar esta loter√≠a? Se procesar√°n reembolsos autom√°ticamente.')) return;
            
            try {
                const token = localStorage.getItem('token');
                const response = await axios.put(`${API_BASE}/${lotteryId}/cancel`, {}, {
                    headers: { Authorization: `Bearer ${token}` }
                });

                const refundedTickets = response.data.data.refunded_tickets;
                const message = refundedTickets > 0 
                    ? `Loter√≠a cancelada exitosamente. Se procesaron ${refundedTickets} reembolsos.`
                    : 'Loter√≠a cancelada exitosamente.';
                
                showAlert(message, 'success');
                loadLotteries(currentPage);
                updateStats();
            } catch (error) {
                console.error('Error al cancelar loter√≠a:', error);
                showAlert(error.response?.data?.message || 'Error al cancelar la loter√≠a', 'danger');
            }
        }

        // Eliminar loter√≠a
        async function deleteLottery(lotteryId) {
            try {
                // Primero obtener informaci√≥n de la loter√≠a para verificar si tiene tickets vendidos
                const token = localStorage.getItem('token');
                const lotteryResponse = await axios.get(`${API_BASE}/${lotteryId}`, {
                    headers: { Authorization: `Bearer ${token}` }
                });
                
                const lottery = lotteryResponse.data.data;
                const hasTicketsSold = lottery.tickets_sold > 0;
                
                let confirmMessage;
                if (hasTicketsSold) {
                    confirmMessage = `‚ö†Ô∏è ADVERTENCIA: Esta loter√≠a tiene ${lottery.tickets_sold} tickets vendidos.\n\n` +
                                   `Al eliminarla se perder√°n TODOS los datos incluyendo:\n` +
                                   `‚Ä¢ ${lottery.tickets_sold} tickets de usuarios\n` +
                                   `‚Ä¢ Historial de participaci√≥n\n` +
                                   `‚Ä¢ Posibles ganadores\n\n` +
                                   `¬øEst√°s COMPLETAMENTE SEGURO de que quieres eliminar "${lottery.title}"?\n\n` +
                                   `Esta acci√≥n NO SE PUEDE DESHACER.`;
                } else {
                    confirmMessage = `¬øEst√°s seguro de que quieres eliminar la loter√≠a "${lottery.title}"?\n\n` +
                                   `Esta acci√≥n no se puede deshacer.`;
                }
                
                if (!confirm(confirmMessage)) return;
                
                // Si tiene tickets vendidos, pedir confirmaci√≥n adicional
                if (hasTicketsSold) {
                    const finalConfirm = prompt(
                        `Para confirmar que entiendes las consecuencias, escribe: ELIMINAR\n\n` +
                        `(Se eliminar√°n ${lottery.tickets_sold} tickets vendidos)`
                    );
                    
                    if (finalConfirm !== 'ELIMINAR') {
                        showAlert('Eliminaci√≥n cancelada', 'info');
                        return;
                    }
                }
                
                const response = await axios.delete(`${API_BASE}/${lotteryId}`, {
                    headers: { Authorization: `Bearer ${token}` }
                });

                const deletedTickets = response.data.data.deleted_tickets || 0;
                let message = response.data.message;
                
                if (deletedTickets > 0) {
                    message += ` ‚ö†Ô∏è Se eliminaron ${deletedTickets} tickets de usuarios.`;
                }
                
                showAlert(message, deletedTickets > 0 ? 'warning' : 'success');
                loadLotteries(currentPage);
                updateStats();
                
            } catch (error) {
                console.error('Error al eliminar loter√≠a:', error);
                showAlert(error.response?.data?.message || 'Error al eliminar la loter√≠a', 'danger');
            }
        }

        // Editar loter√≠a
        async function editLottery(lotteryId) {
            try {
                const token = localStorage.getItem('token');
                const response = await axios.get(`${API_BASE}/${lotteryId}`, {
                    headers: { Authorization: `Bearer ${token}` }
                });

                const lottery = response.data.data;
                
                // Verificar que la loter√≠a puede ser editada (draft, cancelled o active)
                if (!['draft', 'cancelled', 'active'].includes(lottery.status)) {
                    showAlert('Solo se pueden editar loter√≠as en estado borrador, canceladas o activas', 'warning');
                    return;
                }
                
                // Advertencia especial para loter√≠as activas con tickets vendidos
                if (lottery.status === 'active' && lottery.tickets_sold > 0) {
                    const proceedEdit = confirm(`‚ö†Ô∏è ADVERTENCIA: Esta loter√≠a est√° ACTIVA y tiene ${lottery.tickets_sold} tickets vendidos.
                    
Al editarla, solo podr√°s modificar:
‚Ä¢ T√≠tulo y descripci√≥n
‚Ä¢ Imagen
‚Ä¢ Fechas de inicio y fin
‚Ä¢ Descripci√≥n del premio
‚Ä¢ T√©rminos y condiciones

NO podr√°s cambiar:
‚Ä¢ Precio de tickets
‚Ä¢ Cantidad m√°xima/m√≠nima de tickets
‚Ä¢ N√∫mero de ganadores
‚Ä¢ Si es gratis o de pago

¬øDeseas continuar con la edici√≥n?`);
                    
                    if (!proceedEdit) {
                        return;
                    }
                }
                
                // Llenar el formulario con los datos existentes
                currentLotteryId = lotteryId;
                document.getElementById('lotteryModalTitle').textContent = 'Editar Loter√≠a';
                
                document.getElementById('title').value = lottery.title || '';
                document.getElementById('description').value = lottery.description || '';
                document.getElementById('is_free').value = lottery.is_free ? 'true' : 'false';
                document.getElementById('ticket_price').value = lottery.ticket_price || 0;
                document.getElementById('min_tickets').value = lottery.min_tickets || 1;
                document.getElementById('max_tickets').value = lottery.max_tickets || 100;
                document.getElementById('num_winners').value = lottery.num_winners || 1;
                
                // Formatear fechas para el input datetime-local
                const startDate = new Date(lottery.start_date);
                const endDate = new Date(lottery.end_date);
                document.getElementById('start_date').value = formatDateTimeLocal(startDate);
                document.getElementById('end_date').value = formatDateTimeLocal(endDate);
                
                // Los campos prize_description y terms_conditions fueron eliminados
                
                // Deshabilitar campos restringidos para loter√≠as activas con tickets vendidos
                const isActiveWithTickets = lottery.status === 'active' && lottery.tickets_sold > 0;
                const restrictedFields = ['is_free', 'ticket_price', 'min_tickets', 'max_tickets', 'num_winners'];
                
                restrictedFields.forEach(fieldId => {
                    const element = document.getElementById(fieldId);
                    if (element) {
                        element.disabled = isActiveWithTickets;
                        if (isActiveWithTickets) {
                            element.style.backgroundColor = '#f8f9fa';
                            element.style.cursor = 'not-allowed';
                            element.title = 'No se puede modificar en loter√≠as activas con tickets vendidos';
                        } else {
                            element.disabled = false;
                            element.style.backgroundColor = '';
                            element.style.cursor = '';
                            element.title = '';
                        }
                    }
                });
                
                // Actualizar t√≠tulo del modal si es loter√≠a activa con restricciones
                if (isActiveWithTickets) {
                    document.getElementById('lotteryModalTitle').textContent = `Editar Loter√≠a Activa (${lottery.tickets_sold} tickets vendidos)`;
                }
                
                // Mostrar el modal
                new bootstrap.Modal(document.getElementById('lotteryModal')).show();
                
            } catch (error) {
                console.error('Error al cargar loter√≠a para editar:', error);
                showAlert('Error al cargar los datos de la loter√≠a', 'danger');
            }
        }

        // Reanudar loter√≠a cancelada
        async function resumeLottery(lotteryId) {
            try {
                const token = localStorage.getItem('token');
                
                // Obtener datos de la loter√≠a para mostrar informaci√≥n
                const lotteryResponse = await axios.get(`${API_BASE}/${lotteryId}`, {
                    headers: { Authorization: `Bearer ${token}` }
                });
                
                const lottery = lotteryResponse.data.data;
                
                // Verificar que la loter√≠a est√° cancelada
                if (lottery.status !== 'cancelled') {
                    showAlert('Solo se pueden reanudar loter√≠as canceladas', 'warning');
                    return;
                }
                
                // Preguntar al usuario el nuevo estado
                const resumeOptions = `¬øC√≥mo quieres reanudar la loter√≠a "${lottery.title}"?

Opciones:
1 - Como BORRADOR (podr√°s editarla antes de activar)
2 - Como ACTIVA (usuarios podr√°n participar inmediatamente)

Escribe 1 o 2:`;
                
                const choice = prompt(resumeOptions);
                
                if (!choice || !['1', '2'].includes(choice)) {
                    showAlert('Reanudaci√≥n cancelada', 'info');
                    return;
                }
                
                const newStatus = choice === '1' ? 'draft' : 'active';
                const statusText = choice === '1' ? 'borrador' : 'activa';
                
                // Confirmar la acci√≥n
                const confirmMessage = `¬øConfirmas reanudar la loter√≠a como ${statusText.toUpperCase()}?

Loter√≠a: ${lottery.title}
Estado actual: Cancelada
Nuevo estado: ${statusText}

Los tickets que fueron reembolsados NO se restaurar√°n autom√°ticamente.`;
                
                if (!confirm(confirmMessage)) return;
                
                // Hacer la petici√≥n para cambiar el estado
                const response = await axios.put(`${API_BASE}/${lotteryId}`, {
                    status: newStatus
                }, {
                    headers: { Authorization: `Bearer ${token}` }
                });
                
                showAlert(`Loter√≠a reanudada como ${statusText} exitosamente`, 'success');
                loadLotteries(currentPage);
                updateStats();
                
            } catch (error) {
                console.error('Error al reanudar loter√≠a:', error);
                showAlert(error.response?.data?.message || 'Error al reanudar la loter√≠a', 'danger');
            }
        }

        // Ver ganadores
        async function viewWinners(lotteryId) {
            try {
                const token = localStorage.getItem('token');
                const response = await axios.get(`${API_BASE}/${lotteryId}/winners`, {
                    headers: { Authorization: `Bearer ${token}` }
                });

                const winners = response.data.data;
                const modalBody = document.getElementById('detailsModalBody');
                
                if (winners.length === 0) {
                    modalBody.innerHTML = `
                        <div class="text-center py-4">
                            <i class="fas fa-trophy fa-3x text-muted mb-3"></i>
                            <h5>No hay ganadores seleccionados</h5>
                            <p class="text-muted">Los ganadores se seleccionar√°n cuando la loter√≠a finalice</p>
                        </div>
                    `;
                } else {
                    let winnersHtml = '<h5>Ganadores</h5><div class="row">';
                    winners.forEach(winner => {
                        winnersHtml += `
                            <div class="col-md-6 mb-3">
                                <div class="card border-success">
                                    <div class="card-body">
                                        <h6 class="card-title">
                                            <i class="fas fa-trophy text-success"></i> 
                                            Ticket #${winner.ticket_number}
                                        </h6>
                                        <p class="card-text">
                                            <strong>Usuario:</strong> ${winner.username}<br>
                                            <strong>Email:</strong> ${winner.email}<br>
                                            <strong>Premio:</strong> ${winner.prize_description || 'No especificado'}
                                        </p>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    winnersHtml += '</div>';
                    modalBody.innerHTML = winnersHtml;
                }
                
                new bootstrap.Modal(document.getElementById('detailsModal')).show();
            } catch (error) {
                console.error('Error al cargar ganadores:', error);
                showAlert('Error al cargar los ganadores', 'danger');
            }
        }

        // Verificar loter√≠as vencidas
        async function checkOverdueLotteries() {
            try {
                const token = localStorage.getItem('token');
                const response = await axios.get(`${API_BASE}?status=active`, {
                    headers: { Authorization: `Bearer ${token}` }
                });

                const overdueLotteries = response.data.data.filter(l => l.current_status === 'overdue');
                
                if (overdueLotteries.length === 0) {
                    showAlert('No hay loter√≠as vencidas', 'info');
                } else {
                    showAlert(`Hay ${overdueLotteries.length} loter√≠a(s) vencida(s) que requieren finalizaci√≥n`, 'warning');
                }
            } catch (error) {
                console.error('Error al verificar loter√≠as vencidas:', error);
                showAlert('Error al verificar loter√≠as vencidas', 'danger');
            }
        }

        // Refrescar loter√≠as
        function refreshLotteries() {
            loadLotteries(currentPage);
            updateStats();
        }

        // Generar reporte
        async function generateReport(lotteryId) {
            try {
                const token = localStorage.getItem('token');
                const response = await axios.get(`${API_BASE}/${lotteryId}`, {
                    headers: { Authorization: `Bearer ${token}` }
                });

                const lottery = response.data.data;
                
                // Crear reporte simple
                const report = `
                    REPORTE DE LOTER√çA
                    ==================
                    T√≠tulo: ${lottery.title}
                    Estado: ${getStatusText(lottery.current_status || lottery.status)}
                    Tickets vendidos: ${lottery.tickets_sold || 0}/${lottery.max_tickets}
                    Participaci√≥n: ${Math.round((lottery.tickets_sold || 0) / lottery.max_tickets * 100)}%
                    Ganadores: ${lottery.winners_selected || 0}/${lottery.num_winners}
                    Fecha de fin: ${formatDate(lottery.end_date)}
                `;
                
                // Crear archivo de descarga
                const blob = new Blob([report], { type: 'text/plain' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `reporte-loteria-${lotteryId}.txt`;
                a.click();
                window.URL.revokeObjectURL(url);
                
                showAlert('Reporte descargado exitosamente', 'success');
            } catch (error) {
                console.error('Error al generar reporte:', error);
                showAlert('Error al generar el reporte', 'danger');
            }
        }

        // Configurar campo de precio seg√∫n tipo de loter√≠a
        function setupPriceField() {
            const isFreeSelect = document.getElementById('is_free');
            const priceContainer = document.getElementById('priceFieldContainer');
            const priceInput = document.getElementById('ticket_price');
            
            if (isFreeSelect.value === 'true') {
                // Loter√≠a gratuita
                priceContainer.style.display = 'none';
                priceInput.required = false;
                priceInput.value = '0';
            } else {
                // Loter√≠a de pago
                priceContainer.style.display = 'block';
                priceInput.required = true;
                priceInput.value = '100';
            }
        }

        // Event listener para cambio de tipo de loter√≠a
        document.addEventListener('DOMContentLoaded', function() {
            const isFreeSelect = document.getElementById('is_free');
            if (isFreeSelect) {
                isFreeSelect.addEventListener('change', setupPriceField);
            }
        });

        // Funciones auxiliares
        function getStatusClass(status) {
            const classes = {
                'draft': 'bg-secondary',
                'active': 'bg-primary',
                'running': 'bg-success',
                'pending': 'bg-warning',
                'overdue': 'bg-danger',
                'closed': 'bg-dark',
                'finished': 'bg-success',
                'cancelled': 'bg-danger'
            };
            return classes[status] || 'bg-secondary';
        }

        function getStatusText(status) {
            const texts = {
                'draft': 'Borrador',
                'active': 'Activa',
                'running': 'En curso',
                'pending': 'Pendiente',
                'overdue': 'Vencida',
                'closed': 'Cerrada',
                'finished': 'Finalizada',
                'cancelled': 'Cancelada'
            };
            return texts[status] || status;
        }

        function formatDate(dateString) {
            return new Date(dateString).toLocaleString('es-ES');
        }

        function formatDateTimeLocal(date) {
            const d = new Date(date);
            return d.toISOString().slice(0, 16);
        }

        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }

        // Funciones de utilidad para modales
        function closeModal(modalId) {
            try {
                const modalElement = document.getElementById(modalId);
                const modalInstance = bootstrap.Modal.getInstance(modalElement);
                
                if (modalInstance) {
                    modalInstance.hide();
                }
                
                // Limpiar backdrop si se queda colgado
                setTimeout(() => {
                    const backdrops = document.querySelectorAll('.modal-backdrop');
                    backdrops.forEach(backdrop => backdrop.remove());
                    
                    // Restaurar scroll del body
                    document.body.classList.remove('modal-open');
                    document.body.style.overflow = '';
                    document.body.style.paddingRight = '';
                    
                    // Limpiar aria-hidden
                    modalElement.setAttribute('aria-hidden', 'true');
                    modalElement.style.display = 'none';
                }, 300);
                
            } catch (error) {
                console.error('Error cerrando modal:', error);
                // Forzar limpieza si hay error
                forceCloseAllModals();
            }
        }

        function forceCloseAllModals() {
            // Limpiar todos los backdrops
            document.querySelectorAll('.modal-backdrop').forEach(backdrop => backdrop.remove());
            
            // Limpiar todos los modales
            document.querySelectorAll('.modal').forEach(modal => {
                modal.style.display = 'none';
                modal.setAttribute('aria-hidden', 'true');
                modal.classList.remove('show');
            });
            
            // Restaurar body
            document.body.classList.remove('modal-open');
            document.body.style.overflow = '';
            document.body.style.paddingRight = '';
        }

        // Limpiar modales al cargar la p√°gina
        window.addEventListener('load', () => {
            forceCloseAllModals();
            
            // Agregar listeners para limpiar modales cuando se cierren
            const modals = ['lotteryModal', 'detailsModal'];
            modals.forEach(modalId => {
                const modalElement = document.getElementById(modalId);
                if (modalElement) {
                    modalElement.addEventListener('hidden.bs.modal', () => {
                        setTimeout(() => {
                            forceCloseAllModals();
                        }, 100);
                    });
                }
            });
        });

        function logout() {
            localStorage.removeItem('token');
            window.location.href = '/login.html';
        }

        // Event listeners para filtros
        document.getElementById('statusFilter').addEventListener('change', () => loadLotteries(1));
        document.getElementById('typeFilter').addEventListener('change', () => loadLotteries(1));
        
        // Event listener para cambio de tipo de loter√≠a en el modal
        document.addEventListener('DOMContentLoaded', function() {
            const isFreeSelect = document.getElementById('is_free');
            if (isFreeSelect) {
                isFreeSelect.addEventListener('change', setupPriceField);
            }
        });
    </script>
</body>
</html> 