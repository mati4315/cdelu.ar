<!DOCTYPE html>
<html lang="es" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administración de Loterías - CdelU</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            --border-radius-sm: 6px;
            --border-radius: 12px;
            --border-radius-lg: 16px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        /* === VARIABLES DE TEMA OSCURO === */
        [data-theme="dark"] {
            --bg-primary: #0a0a0a;
            --bg-secondary: #111111;
            --bg-tertiary: #1a1a1a;
            --bg-elevated: #212121;
            --bg-surface: #2a2a2a;
            
            --text-primary: #ffffff;
            --text-secondary: #e5e5e5;
            --text-tertiary: #a3a3a3;
            --text-muted: #737373;
            
            --border-primary: #262626;
            --border-secondary: #404040;
            
            --accent-primary: #6366f1;
            --accent-secondary: #8b5cf6;
            --accent-hover: #4f46e5;
            
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --info: #3b82f6;
            
            --sidebar-bg: linear-gradient(180deg, #111111 0%, #0a0a0a 100%);
            --card-bg: #1a1a1a;
            --input-bg: #262626;
            --hover-bg: rgba(255, 255, 255, 0.05);
        }
        
        /* === VARIABLES DE TEMA CLARO === */
        [data-theme="light"] {
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --bg-tertiary: #f1f5f9;
            --bg-elevated: #ffffff;
            --bg-surface: #f8fafc;
            
            --text-primary: #0f172a;
            --text-secondary: #334155;
            --text-tertiary: #64748b;
            --text-muted: #94a3b8;
            
            --border-primary: #e2e8f0;
            --border-secondary: #cbd5e1;
            
            --accent-primary: #6366f1;
            --accent-secondary: #8b5cf6;
            --accent-hover: #4f46e5;
            
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --info: #3b82f6;
            
            --sidebar-bg: linear-gradient(180deg, #1e293b 0%, #0f172a 100%);
            --card-bg: #ffffff;
            --input-bg: #ffffff;
            --hover-bg: rgba(0, 0, 0, 0.05);
        }
        
        /* === ESTILOS BASE === */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: var(--font-family);
            background: var(--bg-secondary);
            color: var(--text-primary);
            line-height: 1.6;
            transition: var(--transition);
            font-weight: 400;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        /* === DASHBOARD LAYOUT === */
        .dashboard-container {
            display: flex;
            min-height: 100vh;
        }
        
        /* === SIDEBAR === */
        .sidebar {
            width: 280px;
            background: var(--sidebar-bg);
            border-right: 1px solid var(--border-primary);
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            overflow-y: auto;
            z-index: 1000;
            transition: var(--transition);
        }
        
        .sidebar-header {
            padding: 2rem;
            border-bottom: 1px solid var(--border-primary);
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            text-decoration: none;
            color: var(--text-primary);
        }
        
        .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border-radius: var(--border-radius);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.25rem;
        }
        
        .logo-text {
            font-size: 1.5rem;
            font-weight: 700;
            margin: 0;
        }
        
        .nav-menu {
            padding: 1.5rem 0;
        }
        
        .nav-group {
            margin-bottom: 2rem;
        }
        
        .nav-group-title {
            padding: 0 2rem 0.75rem;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
        }
        
        .nav-item {
            margin-bottom: 0.25rem;
        }
        
        .nav-link {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 2rem;
            color: var(--text-secondary);
            text-decoration: none;
            transition: var(--transition);
            position: relative;
            font-weight: 500;
        }
        
        .nav-link:hover {
            background: var(--hover-bg);
            color: var(--text-primary);
        }
        
        .nav-link.active {
            background: var(--accent-primary);
            color: white;
        }
        
        .nav-link.active::before {
            content: '';
            position: absolute;
            left: -1rem;
            top: 50%;
            transform: translateY(-50%);
            width: 3px;
            height: 20px;
            background: white;
            border-radius: 2px;
        }
        
        .nav-icon {
            font-size: 1.125rem;
            width: 20px;
            text-align: center;
        }
        
        .main-content {
            flex: 1;
            margin-left: 280px;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        
        .top-bar {
            background: var(--bg-elevated);
            border-bottom: 1px solid var(--border-primary);
            padding: 1rem 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            backdrop-filter: blur(10px);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .page-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }
        
        .top-bar-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .theme-toggle {
            position: relative;
            width: 48px;
            height: 28px;
        }
        
        .theme-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .theme-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--border-secondary);
            transition: var(--transition);
            border-radius: 50px;
            display: flex;
            align-items: center;
            padding: 0 4px;
        }
        
        .theme-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            background: var(--bg-elevated);
            transition: var(--transition);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow);
        }
        
        input:checked + .theme-slider {
            background: var(--accent-primary);
        }
        
        input:checked + .theme-slider:before {
            transform: translateX(20px);
        }
        
        .theme-icon {
            position: absolute;
            font-size: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            transition: var(--transition);
        }
        
        .theme-icon.sun {
            right: 6px;
            color: var(--warning);
        }
        
        .theme-icon.moon {
            left: 6px;
            color: var(--text-muted);
        }
        
        input:checked + .theme-slider .theme-icon.sun {
            opacity: 0;
        }
        
        input:not(:checked) + .theme-slider .theme-icon.moon {
            opacity: 0;
        }
        
        .content-area {
            flex: 1;
            padding: 2rem;
            overflow-y: auto;
        }
        
        /* === CARDS === */
        .card {
            background: var(--card-bg);
            border: 1px solid var(--border-primary);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow);
            transition: var(--transition);
            overflow: hidden;
        }
        
        .card:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-2px);
        }
        
        .card-header {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: white;
            padding: 1.5rem 2rem;
            border: none;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .card-header h3 {
            margin: 0;
            font-weight: 600;
            font-size: 1.125rem;
        }
        
        .card-body {
            padding: 2rem;
            color: var(--text-secondary);
            min-height: 200px;
        }
        
        /* === LOTTERY CARDS === */
        .lottery-card {
            transition: all 0.3s ease;
            height: 100%;
            min-height: 300px;
        }
        
        .lottery-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }
        
        .lottery-progress {
            background-color: var(--bg-tertiary);
            border-radius: 10px;
            overflow: hidden;
        }
        
        .lottery-progress .progress-bar {
            transition: width 0.6s ease;
        }
        
        .lottery-stats-box {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-primary);
            border-radius: var(--border-radius);
            padding: 0.75rem;
            transition: all 0.3s ease;
        }
        
        .lottery-stats-box:hover {
            background: var(--hover-bg);
            border-color: var(--accent-primary);
        }
        
        .lottery-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.75rem;
            border-radius: 50px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .lottery-title {
            font-weight: 600;
            color: var(--text-primary);
            line-height: 1.3;
        }
        
        .lottery-description {
            color: var(--text-tertiary);
            line-height: 1.4;
        }
        
        .lottery-actions .btn {
            border-radius: var(--border-radius);
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .lottery-actions .btn:hover {
            transform: translateY(-1px);
        }

        /* === LOTTERY FOOTER AND ACTIONS === */
        .lottery-footer {
            margin-top: 1rem;
        }

        .lottery-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            justify-content: center;
        }

        .lottery-actions .btn {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-primary);
            color: var(--text-secondary);
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
            border-radius: var(--border-radius);
            transition: all 0.3s ease;
            min-width: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .lottery-actions .btn:hover {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
            color: white;
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .lottery-actions .btn:active {
            transform: translateY(0);
        }

        .lottery-actions .btn.btn-outline-primary:hover {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
            color: white;
        }

        .lottery-actions .btn.btn-outline-success:hover {
            background: var(--success);
            border-color: var(--success);
            color: white;
        }

        .lottery-actions .btn.btn-outline-warning:hover {
            background: var(--warning);
            border-color: var(--warning);
            color: white;
        }

        .lottery-actions .btn.btn-outline-danger:hover {
            background: var(--error);
            border-color: var(--error);
            color: white;
        }

        .lottery-actions .btn.btn-outline-dark:hover {
            background: var(--text-primary);
            border-color: var(--text-primary);
            color: white;
        }
        
        /* === LOTTERY STATS CARDS === */
        .stats-card {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: white;
            border: none;
            transition: var(--transition);
        }
        
        .stats-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        
        .stats-card .card-body {
            padding: 1.5rem;
            min-height: 120px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        .stats-card h5 {
            margin-bottom: 0.5rem;
            opacity: 0.9;
        }
        
        .stats-card h4 {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }
        
        .stats-card small {
            opacity: 0.8;
            font-size: 0.875rem;
        }
        
        /* === FORMULARIOS === */
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-primary);
            font-size: 0.875rem;
        }
        
        .form-control {
            background: var(--input-bg);
            border: 1px solid var(--border-primary);
            border-radius: var(--border-radius);
            color: var(--text-primary);
            padding: 0.75rem 1rem;
            transition: var(--transition);
            font-size: 0.875rem;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
        
        /* === BOTONES === */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            border-radius: var(--border-radius);
            font-weight: 500;
            font-size: 0.875rem;
            text-decoration: none;
            transition: var(--transition);
            border: none;
            cursor: pointer;
            justify-content: center;
        }
        
        .btn-primary {
            background: var(--accent-primary);
            color: white;
        }
        
        .btn-primary:hover {
            background: var(--accent-hover);
            transform: translateY(-1px);
        }
        
        .btn-outline {
            background: transparent;
            border: 1px solid var(--border-primary);
            color: var(--text-primary);
        }
        
        .btn-outline:hover {
            background: var(--hover-bg);
            border-color: var(--accent-primary);
            color: var(--accent-primary);
        }
        
        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.75rem;
        }
        
        /* === RESPONSIVE === */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }
            
            .sidebar.open {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .mobile-overlay {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.5);
                z-index: 999;
                display: none;
            }
            
            .mobile-overlay.show {
                display: block;
            }
        }
        
        /* === UTILITIES === */
        .text-muted {
            color: var(--text-muted) !important;
        }
        
        .text-primary {
            color: var(--accent-primary) !important;
        }
        
        .text-success {
            color: var(--success) !important;
        }
        
        .text-warning {
            color: var(--warning) !important;
        }
        
        .text-danger {
            color: var(--error) !important;
        }
        
        .bg-primary {
            background-color: var(--accent-primary) !important;
        }
        
        .bg-success {
            background-color: var(--success) !important;
        }
        
        .bg-warning {
            background-color: var(--warning) !important;
        }
        
        .bg-danger {
            background-color: var(--error) !important;
        }
        
        .bg-info {
            background-color: var(--info) !important;
        }
        
        .bg-secondary {
            background-color: var(--text-muted) !important;
        }
        
        .bg-dark {
            background-color: var(--bg-tertiary) !important;
        }
        
        .status-badge {
            font-size: 0.8rem;
        }
        
        .btn-lottery {
            border-radius: 20px;
            font-weight: 500;
        }
        
        .modal-header {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: white;
        }
        
        .form-control:focus {
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 0.2rem rgba(99, 102, 241, 0.25);
        }
    </style>
</head>
<body>
    <!-- Mobile Overlay -->
    <div class="mobile-overlay" id="mobileOverlay"></div>
    
    <!-- Dashboard Container -->
    <div class="dashboard-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <a href="#" class="logo">
                    <div class="logo-icon">
                        <i class="bi bi-trophy"></i>
                    </div>
                    <h1 class="logo-text">CdelU</h1>
                </a>
            </div>
            
            <nav class="nav-menu">
                <div class="nav-group">
                    <div class="nav-group-title">Panel Principal</div>
                    <div class="nav-item">
                        <a href="/dashboard.html" class="nav-link">
                            <i class="nav-icon bi bi-speedometer2"></i>
                            Dashboard
                        </a>
                    </div>
                    <div class="nav-item">
                        <a href="/dashboard.html#news" class="nav-link">
                            <i class="nav-icon bi bi-newspaper"></i>
                            Noticias
                        </a>
                    </div>
                    <div class="nav-item">
                        <a href="/dashboard.html#users" class="nav-link">
                            <i class="nav-icon bi bi-people"></i>
                            Usuarios
                        </a>
                    </div>
                </div>
                
                <div class="nav-group">
                    <div class="nav-group-title">Herramientas</div>
                    <div class="nav-item">
                        <a href="/dashboard.html#stats" class="nav-link">
                            <i class="nav-icon bi bi-graph-up"></i>
                            Estadísticas
                        </a>
                    </div>
                    <div class="nav-item">
                        <a href="/dashboard.html#api-docs" class="nav-link">
                            <i class="nav-icon bi bi-code-square"></i>
                            API Docs
                        </a>
                    </div>
                    <div class="nav-item">
                        <a href="/dashboard.html#communication" class="nav-link">
                            <i class="nav-icon bi bi-chat-dots"></i>
                            Comunicaciones
                        </a>
                    </div>
                    <div class="nav-item">
                        <a href="/ads-dashboard.html" class="nav-link" target="_blank">
                            <i class="nav-icon bi bi-megaphone"></i>
                            Publicidad
                        </a>
                    </div>
                    <div class="nav-item">
                        <a href="#lotteries" class="nav-link active">
                            <i class="nav-icon bi bi-trophy"></i>
                            Loterías
                        </a>
                    </div>
                </div>
                
                <div class="nav-group">
                    <div class="nav-group-title">Sistema</div>
                    <div class="nav-item">
                        <a href="/dashboard.html#health" class="nav-link">
                            <i class="nav-icon bi bi-heart-pulse"></i>
                            Estado del Sistema
                        </a>
                    </div>
                </div>
            </nav>
        </aside>
        
        <!-- Main Content -->
        <main class="main-content">
            <!-- Top Bar -->
            <header class="top-bar">
                <div class="d-flex align-items-center gap-2">
                    <button class="mobile-menu-btn" id="mobileMenuBtn">
                        <i class="bi bi-list"></i>
                    </button>
                    <h1 class="page-title" id="pageTitle">Administración de Loterías</h1>
                </div>
                
                <div class="top-bar-actions">
                    <label class="theme-toggle">
                        <input type="checkbox" id="themeToggle">
                        <span class="theme-slider">
                            <i class="theme-icon sun bi bi-sun-fill"></i>
                            <i class="theme-icon moon bi bi-moon-fill"></i>
                        </span>
                    </label>
                    
                    <button class="btn btn-outline btn-sm" id="logoutBtn">
                        <i class="bi bi-box-arrow-right"></i>
                        Cerrar Sesión
                    </button>
                </div>
            </header>
            
            <!-- Content Area -->
            <div class="content-area">
                <!-- Stats Cards -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card stats-card">
                            <div class="card-body text-center">
                                <h5><i class="bi bi-ticket-alt"></i></h5>
                                <h4 id="totalLotteries">0</h4>
                                <small>Total Loterías</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stats-card">
                            <div class="card-body text-center">
                                <h5><i class="bi bi-play"></i></h5>
                                <h4 id="activeLotteries">0</h4>
                                <small>Activas</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stats-card">
                            <div class="card-body text-center">
                                <h5><i class="bi bi-trophy"></i></h5>
                                <h4 id="finishedLotteries">0</h4>
                                <small>Finalizadas</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stats-card">
                            <div class="card-body text-center">
                                <h5><i class="bi bi-people"></i></h5>
                                <h4 id="totalParticipants">0</h4>
                                <small>Participantes</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Controls -->
                <div class="card mb-4">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <div class="d-flex gap-2">
                                <button class="btn btn-primary" onclick="showCreateLotteryModal()">
                                    <i class="bi bi-plus-circle"></i>
                                    Nueva Lotería
                                </button>
                                <button class="btn btn-outline" onclick="refreshLotteries()">
                                    <i class="bi bi-arrow-clockwise"></i>
                                    Actualizar
                                </button>
                                <button class="btn btn-outline" onclick="checkOverdueLotteries()">
                                    <i class="bi bi-clock"></i>
                                    Verificar Vencidas
                                </button>
                            </div>
                            <div class="d-flex gap-2 align-items-center">
                                <select class="form-control" id="statusFilter" style="width: auto;">
                                    <option value="">Todos los estados</option>
                                    <option value="draft">Borrador</option>
                                    <option value="active" selected>Activa</option>
                                    <option value="closed">Cerrada</option>
                                    <option value="finished">Finalizada</option>
                                    <option value="cancelled">Cancelada</option>
                                </select>
                                <select class="form-control" id="typeFilter" style="width: auto;">
                                    <option value="">Todos los tipos</option>
                                    <option value="true">Gratuitas</option>
                                    <option value="false">De pago</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Lotteries List -->
                <div class="row" id="lotteriesContainer">
                    <!-- Las loterías se cargarán aquí dinámicamente -->
                </div>

                <!-- Pagination -->
                <nav aria-label="Paginación de loterías" class="mt-4">
                    <ul class="pagination justify-content-center" id="pagination">
                        <!-- Paginación se generará dinámicamente -->
                    </ul>
                </nav>
            </div>
        </main>
    </div>

            <!-- Main Content -->
            <div class="col-md-9 col-lg-10 content-area p-4">
                <!-- Stats Cards -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card stats-card">
                            <div class="card-body text-center">
                                <h5><i class="bi bi-ticket-alt"></i></h5>
                                <h4 id="totalLotteries">0</h4>
                                <small>Total Loterías</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stats-card">
                            <div class="card-body text-center">
                                <h5><i class="bi bi-play"></i></h5>
                                <h4 id="activeLotteries">0</h4>
                                <small>Activas</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stats-card">
                            <div class="card-body text-center">
                                <h5><i class="bi bi-trophy"></i></h5>
                                <h4 id="finishedLotteries">0</h4>
                                <small>Finalizadas</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stats-card">
                            <div class="card-body text-center">
                                <h5><i class="bi bi-people"></i></h5>
                                <h4 id="totalParticipants">0</h4>
                                <small>Participantes</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Lotteries List -->
                <div class="row" id="lotteriesContainer">
                    <!-- Las loterías se cargarán aquí dinámicamente -->
                </div>

                <!-- Pagination -->
                <nav aria-label="Paginación de loterías" class="mt-4">
                    <ul class="pagination justify-content-center" id="pagination">
                        <!-- Paginación se generará dinámicamente -->
                    </ul>
                </nav>
            </div>
        </div>
    </div>

    <!-- Modal para crear/editar lotería -->
    <div class="modal fade" id="lotteryModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="lotteryModalTitle">Nueva Lotería</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="lotteryForm">
                        <div class="row">
                            <div class="col-md-8">
                                <div class="mb-3">
                                    <label for="title" class="form-label">Título *</label>
                                    <input type="text" class="form-control" id="title" required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="is_free" class="form-label">Tipo</label>
                                    <select class="form-select" id="is_free">
                                        <option value="true" selected>Gratuita</option>
                                        <option value="false">De pago</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="description" class="form-label">Descripción</label>
                            <textarea class="form-control" id="description" rows="3"></textarea>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="min_tickets" class="form-label">Tickets mínimos</label>
                                    <input type="number" class="form-control" id="min_tickets" value="1" min="1">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="max_tickets" class="form-label">Tickets máximos *</label>
                                    <input type="number" class="form-control" id="max_tickets" required min="1" value="100">
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="num_winners" class="form-label">Número de ganadores</label>
                                    <input type="number" class="form-control" id="num_winners" value="1" min="1">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3" id="priceFieldContainer" style="display: none;">
                                    <label for="ticket_price" class="form-label">Precio por ticket *</label>
                                    <input type="number" class="form-control" id="ticket_price" value="100" min="100" step="0.01" required>
                                    <div class="form-text">Mínimo $100</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="start_date" class="form-label">Fecha de inicio *</label>
                                    <input type="datetime-local" class="form-control" id="start_date" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="end_date" class="form-label">Fecha de fin *</label>
                                    <input type="datetime-local" class="form-control" id="end_date" required>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="saveLottery()">Guardar Lotería</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para ver detalles -->
    <div class="modal fade" id="detailsModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Detalles de Lotería</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="detailsModalBody">
                    <!-- Contenido se cargará dinámicamente -->
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        // Configuración global
        const API_BASE = '/api/v1/lotteries';
        let currentPage = 1;
        let currentLotteryId = null;

        // Verificar autenticación al cargar
        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
            loadLotteries();
            updateStats();
        });

        // Verificar autenticación
        async function checkAuth() {
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    window.location.href = '/login.html';
                    return;
                }

                const response = await axios.get('/api/v1/auth/me', {
                    headers: { Authorization: `Bearer ${token}` }
                });

                if (response.data.user.rol !== 'administrador') {
                    alert('Acceso denegado. Solo administradores pueden acceder.');
                    window.location.href = '/dashboard.html';
                    return;
                }

                document.getElementById('username').textContent = response.data.user.nombre;
            } catch (error) {
                console.error('Error de autenticación:', error);
                window.location.href = '/login.html';
            }
        }

        // Cargar loterías
        async function loadLotteries(page = 1) {
            try {
                const token = localStorage.getItem('token');
                const statusFilter = document.getElementById('statusFilter').value;
                const typeFilter = document.getElementById('typeFilter').value;

                let url = `${API_BASE}?page=${page}&limit=12`;
                if (statusFilter) url += `&status=${statusFilter}`;
                if (typeFilter) url += `&is_free=${typeFilter}`;

                const response = await axios.get(url, {
                    headers: { Authorization: `Bearer ${token}` }
                });

                displayLotteries(response.data.data);
                displayPagination(response.data.pagination);
                currentPage = page;
            } catch (error) {
                console.error('Error al cargar loterías:', error);
                showAlert('Error al cargar las loterías', 'danger');
            }
        }

        // Mostrar loterías
        function displayLotteries(lotteries) {
            const container = document.getElementById('lotteriesContainer');
            container.innerHTML = '';

            if (lotteries.length === 0) {
                container.innerHTML = `
                    <div class="col-12 text-center py-5">
                        <i class="fas fa-ticket-alt fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">No hay loterías disponibles</h5>
                        <p class="text-muted">Crea tu primera lotería usando el botón "Nueva Lotería"</p>
                    </div>
                `;
                return;
            }

            lotteries.forEach(lottery => {
                const card = createLotteryCard(lottery);
                container.appendChild(card);
            });
        }

        // Crear tarjeta de lotería
        function createLotteryCard(lottery) {
            const col = document.createElement('div');
            col.className = 'col-md-6 col-lg-4 mb-4';
            
            const statusClass = getStatusClass(lottery.current_status || lottery.status);
            const isFree = lottery.is_free ? 'Gratuita' : 'De pago';
            const price = lottery.is_free ? 'Gratis' : `$${lottery.ticket_price}`;
            
            col.innerHTML = `
                <div class="card lottery-card h-100">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span class="badge ${statusClass} status-badge">${getStatusText(lottery.current_status || lottery.status)}</span>
                        <span class="badge bg-info status-badge">${isFree}</span>
                    </div>
                    <div class="card-body">
                        <h6 class="card-title">${lottery.title}</h6>
                        <p class="card-text text-muted small">${lottery.description || 'Sin descripción'}</p>
                        
                        <div class="row text-center mb-3">
                            <div class="col-6">
                                <small class="text-muted">Tickets vendidos</small>
                                <div class="fw-bold">${lottery.tickets_sold || 0}/${lottery.max_tickets}</div>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">Precio</small>
                                <div class="fw-bold">${price}</div>
                            </div>
                        </div>
                        
                        <div class="row text-center mb-3">
                            <div class="col-6">
                                <small class="text-muted">Ganadores</small>
                                <div class="fw-bold">${lottery.winners_selected || 0}/${lottery.num_winners}</div>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">Participación</small>
                                <div class="fw-bold">${Math.round((lottery.tickets_sold || 0) / lottery.max_tickets * 100)}%</div>
                            </div>
                        </div>
                        
                        <hr>
                        <div class="lottery-footer">
                            <small class="text-muted d-block mb-2">
                                <i class="bi bi-calendar"></i> ${formatDate(lottery.end_date)}
                            </small>
                            <div class="lottery-actions">
                                                                        <button class="btn btn-outline-primary" onclick="viewDetails(${lottery.id})" title="Ver detalles">
                                            <i class="bi bi-eye"></i>
                                        </button>
                                ${lottery.status === 'draft' ? `
                                                                                <button class="btn btn-outline-success" onclick="editLottery(${lottery.id})" title="Editar">
                                                <i class="bi bi-pencil"></i>
                                            </button>
                                            <button class="btn btn-outline-warning" onclick="activateLottery(${lottery.id})" title="Activar">
                                                <i class="bi bi-play"></i>
                                            </button>
                                            <button class="btn btn-outline-danger" onclick="deleteLottery(${lottery.id})" title="Eliminar">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                ` : ''}
                                ${lottery.status === 'active' ? `
                                    <button class="btn btn-outline-warning" onclick="finishLottery(${lottery.id})" title="Finalizar Lotería">
                                        <i class="bi bi-trophy"></i>
                                    </button>
                                    <button class="btn btn-outline-success" onclick="editLottery(${lottery.id})" title="Editar">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button class="btn btn-outline-danger" onclick="cancelLottery(${lottery.id})" title="Cancelar">
                                        <i class="bi bi-x-circle"></i>
                                    </button>
                                    <button class="btn btn-outline-dark" onclick="deleteLottery(${lottery.id})" title="Eliminar">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                ` : ''}
                                ${lottery.status === 'cancelled' ? `
                                    <button class="btn btn-outline-success" onclick="editLottery(${lottery.id})" title="Editar">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button class="btn btn-outline-primary" onclick="resumeLottery(${lottery.id})" title="Reanudar">
                                        <i class="bi bi-play-circle"></i>
                                    </button>
                                    <button class="btn btn-outline-danger" onclick="deleteLottery(${lottery.id})" title="Eliminar">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                ` : ''}
                                ${lottery.current_status === 'overdue' ? `
                                    <button class="btn btn-outline-danger" onclick="finishLottery(${lottery.id})" title="Finalizar (Vencida)">
                                        <i class="bi bi-trophy"></i>
                                    </button>
                                    <button class="btn btn-outline-dark" onclick="deleteLottery(${lottery.id})" title="Eliminar">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                ` : ''}
                                ${lottery.status === 'finished' ? `
                                    <button class="btn btn-outline-dark" onclick="deleteLottery(${lottery.id})" title="Eliminar">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            return col;
        }

        // Mostrar paginación
        function displayPagination(pagination) {
            const container = document.getElementById('pagination');
            container.innerHTML = '';

            if (pagination.pages <= 1) return;

            // Botón anterior
            const prevLi = document.createElement('li');
            prevLi.className = `page-item ${pagination.page <= 1 ? 'disabled' : ''}`;
            prevLi.innerHTML = `<a class="page-link" href="#" onclick="loadLotteries(${pagination.page - 1})">Anterior</a>`;
            container.appendChild(prevLi);

            // Páginas
            for (let i = 1; i <= pagination.pages; i++) {
                const li = document.createElement('li');
                li.className = `page-item ${i === pagination.page ? 'active' : ''}`;
                li.innerHTML = `<a class="page-link" href="#" onclick="loadLotteries(${i})">${i}</a>`;
                container.appendChild(li);
            }

            // Botón siguiente
            const nextLi = document.createElement('li');
            nextLi.className = `page-item ${pagination.page >= pagination.pages ? 'disabled' : ''}`;
            nextLi.innerHTML = `<a class="page-link" href="#" onclick="loadLotteries(${pagination.page + 1})">Siguiente</a>`;
            container.appendChild(nextLi);
        }

        // Actualizar estadísticas
        async function updateStats() {
            try {
                const token = localStorage.getItem('token');
                const response = await axios.get(`${API_BASE}?limit=100`, {
                    headers: { Authorization: `Bearer ${token}` }
                });

                const lotteries = response.data.data;
                const stats = {
                    total: lotteries.length,
                    active: lotteries.filter(l => l.current_status === 'running').length,
                    finished: lotteries.filter(l => l.status === 'finished').length,
                    participants: lotteries.reduce((sum, l) => sum + (l.tickets_sold || 0), 0)
                };

                document.getElementById('totalLotteries').textContent = stats.total;
                document.getElementById('activeLotteries').textContent = stats.active;
                document.getElementById('finishedLotteries').textContent = stats.finished;
                document.getElementById('totalParticipants').textContent = stats.participants;
            } catch (error) {
                console.error('Error al actualizar estadísticas:', error);
            }
        }

        // Mostrar modal de crear lotería
        function showCreateLotteryModal() {
            currentLotteryId = null;
            document.getElementById('lotteryModalTitle').textContent = 'Nueva Lotería';
            document.getElementById('lotteryForm').reset();
            
            // Establecer fechas por defecto
            const now = new Date();
            const tomorrow = new Date(now.getTime() + 24 * 60 * 60 * 1000);
            const nextWeek = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000);
            
            document.getElementById('start_date').value = formatDateTimeLocal(now);
            document.getElementById('end_date').value = formatDateTimeLocal(nextWeek);
            
            // Configurar campo de precio según tipo de lotería
            setupPriceField();
            
            new bootstrap.Modal(document.getElementById('lotteryModal')).show();
        }

        // Guardar lotería
        async function saveLottery() {
            try {
                const formData = getFormData();
                const token = localStorage.getItem('token');
                
                const url = currentLotteryId ? `${API_BASE}/${currentLotteryId}` : API_BASE;
                const method = currentLotteryId ? 'put' : 'post';
                
                const response = await axios[method](url, formData, {
                    headers: { Authorization: `Bearer ${token}` }
                });

                // Si es una nueva lotería, activarla automáticamente
                if (!currentLotteryId) {
                    const newLotteryId = response.data.data.id;
                    console.log('🎯 Activando nueva lotería automáticamente...');
                    
                    try {
                        await axios.put(`${API_BASE}/${newLotteryId}`, {
                            status: 'active'
                        }, {
                            headers: { Authorization: `Bearer ${token}` }
                        });
                        
                        showAlert('Lotería creada y activada exitosamente', 'success');
                    } catch (activateError) {
                        console.error('Error al activar lotería:', activateError);
                        showAlert('Lotería creada pero hubo un error al activarla', 'warning');
                    }
                } else {
                    showAlert('Lotería actualizada exitosamente', 'success');
                }
                
                closeModal('lotteryModal');
                loadLotteries(currentPage);
                updateStats();
            } catch (error) {
                console.error('Error al guardar lotería:', error);
                showAlert('Error al guardar la lotería', 'danger');
            }
        }

        // Obtener datos del formulario
        function getFormData() {
            // Convertir fechas al formato ISO correcto
            const startDate = document.getElementById('start_date').value;
            const endDate = document.getElementById('end_date').value;
            
            return {
                title: document.getElementById('title').value,
                description: document.getElementById('description').value,
                is_free: document.getElementById('is_free').value === 'true',
                ticket_price: parseFloat(document.getElementById('ticket_price').value),
                min_tickets: parseInt(document.getElementById('min_tickets').value),
                max_tickets: parseInt(document.getElementById('max_tickets').value),
                num_winners: parseInt(document.getElementById('num_winners').value),
                start_date: startDate ? new Date(startDate).toISOString() : null,
                end_date: endDate ? new Date(endDate).toISOString() : null,
                prize_description: '', // Campo eliminado
                terms_conditions: '' // Campo eliminado
            };
        }

        // Ver detalles de lotería
        async function viewDetails(lotteryId) {
            try {
                const token = localStorage.getItem('token');
                const response = await axios.get(`${API_BASE}/${lotteryId}`, {
                    headers: { Authorization: `Bearer ${token}` }
                });

                const lottery = response.data.data;
                const modalBody = document.getElementById('detailsModalBody');
                
                modalBody.innerHTML = `
                    <div class="row">
                        <div class="col-md-8">
                            <h5>${lottery.title}</h5>
                            <p class="text-muted">${lottery.description || 'Sin descripción'}</p>
                            
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <strong>Tipo:</strong> ${lottery.is_free ? 'Gratuita' : 'De pago'}<br>
                                    <strong>Precio:</strong> ${lottery.is_free ? 'Gratis' : `$${lottery.ticket_price}`}<br>
                                    <strong>Estado:</strong> <span class="badge ${getStatusClass(lottery.current_status || lottery.status)}">${getStatusText(lottery.current_status || lottery.status)}</span>
                                </div>
                                <div class="col-md-6">
                                    <strong>Tickets vendidos:</strong> ${lottery.tickets_sold || 0}/${lottery.max_tickets}<br>
                                    <strong>Ganadores:</strong> ${lottery.winners_selected || 0}/${lottery.num_winners}<br>
                                    <strong>Participación:</strong> ${Math.round((lottery.tickets_sold || 0) / lottery.max_tickets * 100)}%
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <strong>Fecha de inicio:</strong><br>
                                    ${formatDate(lottery.start_date)}
                                </div>
                                <div class="col-md-6">
                                    <strong>Fecha de fin:</strong><br>
                                    ${formatDate(lottery.end_date)}
                                </div>
                            </div>
                            
                            ${lottery.prize_description ? `
                                <div class="mb-3">
                                    <strong>Premio:</strong><br>
                                    ${lottery.prize_description}
                                </div>
                            ` : ''}
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0">Acciones</h6>
                                </div>
                                <div class="card-body">
                                    ${lottery.status === 'draft' ? `
                                        <button class="btn btn-success btn-sm w-100 mb-2" onclick="activateLottery(${lottery.id})">
                                            <i class="fas fa-play"></i> Activar
                                        </button>
                                    ` : ''}
                                    ${lottery.status === 'active' ? `
                                        <button class="btn btn-warning btn-sm w-100 mb-2" onclick="finishLottery(${lottery.id})">
                                            <i class="fas fa-trophy"></i> Finalizar Lotería
                                        </button>
                                        <button class="btn btn-outline-danger btn-sm w-100 mb-2" onclick="cancelLottery(${lottery.id})">
                                            <i class="fas fa-ban"></i> Cancelar
                                        </button>
                                    ` : ''}
                                    ${lottery.current_status === 'overdue' ? `
                                        <button class="btn btn-danger btn-sm w-100 mb-2" onclick="finishLottery(${lottery.id})">
                                            <i class="fas fa-trophy"></i> Finalizar (Vencida)
                                        </button>
                                    ` : ''}
                                    <button class="btn btn-info btn-sm w-100 mb-2" onclick="viewWinners(${lottery.id})">
                                        <i class="fas fa-trophy"></i> Ver Ganadores
                                    </button>
                                    <button class="btn btn-secondary btn-sm w-100" onclick="generateReport(${lottery.id})">
                                        <i class="fas fa-chart-bar"></i> Reporte
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                new bootstrap.Modal(document.getElementById('detailsModal')).show();
            } catch (error) {
                console.error('Error al cargar detalles:', error);
                showAlert('Error al cargar los detalles', 'danger');
            }
        }

        // Activar lotería
        async function activateLottery(lotteryId) {
            if (!confirm('¿Estás seguro de que quieres activar esta lotería?')) return;
            
            try {
                const token = localStorage.getItem('token');
                await axios.put(`${API_BASE}/${lotteryId}`, {
                    status: 'active'
                }, {
                    headers: { Authorization: `Bearer ${token}` }
                });

                showAlert('Lotería activada exitosamente', 'success');
                loadLotteries(currentPage);
                updateStats();
            } catch (error) {
                console.error('Error al activar lotería:', error);
                showAlert('Error al activar la lotería', 'danger');
            }
        }

        // Finalizar lotería
        async function finishLottery(lotteryId, force = false) {
            try {
                const token = localStorage.getItem('token');
                
                // Obtener información de la lotería
                const lotteryResponse = await axios.get(`${API_BASE}/${lotteryId}`, {
                    headers: { Authorization: `Bearer ${token}` }
                });
                
                const lottery = lotteryResponse.data.data;
                const now = new Date();
                const endDate = new Date(lottery.end_date);
                const hasEnded = now >= endDate;
                
                // Si no es forzado, verificar condiciones
                if (!force) {
                    if (!hasEnded) {
                        const minutesLeft = Math.ceil((endDate - now) / (1000 * 60));
                        const forceConfirm = confirm(`⚠️ ADVERTENCIA: Esta lotería aún no ha terminado.
                        
Faltan ${minutesLeft} minutos para que termine oficialmente.
Fecha fin: ${endDate.toLocaleString()}

¿Quieres forzar la finalización de todas formas?`);
                        if (!forceConfirm) return;
                        force = true;
                    } else if (lottery.tickets_sold === 0) {
                        const confirmEmpty = confirm(`⚠️ ADVERTENCIA: Esta lotería no tiene participantes.
                        
• Tickets vendidos: 0
• Mínimo requerido: ${lottery.min_tickets}

Al finalizar, la lotería será cancelada automáticamente.

¿Deseas continuar?`);
                        if (!confirmEmpty) return;
                    }
                }
                
                // Mostrar opciones de finalización
                showFinishOptionsModal(lotteryId, lottery, force);
                
            } catch (error) {
                console.error('Error al finalizar lotería:', error);
                
                if (error.response?.status === 400) {
                    const errorData = error.response.data;
                    
                    // Si el error es por tiempo, ofrecer forzar finalización
                    if (errorData.message?.includes('aún no ha terminado')) {
                        const minutesLeft = errorData.data?.minutes_left || 'algunos';
                        const forceConfirm = confirm(`La lotería aún no ha terminado (faltan ${minutesLeft} minutos).

¿Quieres forzar la finalización de todas formas?

⚠️ Esto finalizará la lotería antes de tiempo.`);
                        
                        if (forceConfirm) {
                            // Llamar recursivamente con force=true
                            return finishLottery(lotteryId, true);
                        }
                    } else {
                        showAlert(`Error: ${errorData.message}`, 'danger');
                    }
                } else {
                    showAlert(`Error al finalizar la lotería: ${error.response?.data?.message || error.message}`, 'danger');
                }
            }
        }

        // Mostrar modal de opciones de finalización
        function showFinishOptionsModal(lotteryId, lottery, force = false) {
            // Crear modal de opciones
            const modalHtml = `
                <div class="modal fade" id="finishOptionsModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header bg-warning text-dark">
                                <h5 class="modal-title">
                                    <i class="fas fa-trophy"></i> 
                                    Finalizar Lotería: ${lottery.title}
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="mb-4">
                                    <h6 class="fw-bold">📊 Información de la Lotería:</h6>
                                    <ul class="list-unstyled">
                                        <li><strong>Tickets vendidos:</strong> ${lottery.tickets_sold || 0}</li>
                                        <li><strong>Ganadores a seleccionar:</strong> ${lottery.num_winners}</li>
                                        <li><strong>Estado:</strong> ${lottery.status}</li>
                                        <li><strong>Fecha fin:</strong> ${formatDate(lottery.end_date)}</li>
                                    </ul>
                                </div>
                                
                                <div class="mb-4">
                                    <h6 class="fw-bold">🎯 Selecciona el método de finalización:</h6>
                                    
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <div class="card h-100 border-primary">
                                                <div class="card-body text-center">
                                                    <i class="fas fa-hand-pointer fa-3x text-primary mb-3"></i>
                                                    <h6 class="card-title">Selección Manual</h6>
                                                    <p class="card-text small">Tú elegirás los números ganadores manualmente</p>
                                                    <button class="btn btn-primary btn-sm" onclick="selectManualFinish(${lotteryId}, ${force})">
                                                        <i class="fas fa-hand-pointer"></i> Elegir Manualmente
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="col-md-6 mb-3">
                                            <div class="card h-100 border-success">
                                                <div class="card-body text-center">
                                                    <i class="fas fa-random fa-3x text-success mb-3"></i>
                                                    <h6 class="card-title">Selección Automática</h6>
                                                    <p class="card-text small">El sistema seleccionará los ganadores al azar</p>
                                                    <button class="btn btn-success btn-sm" onclick="selectAutomaticFinish(${lotteryId}, ${force})">
                                                        <i class="fas fa-random"></i> Selección Automática
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle"></i> 
                                    <strong>Nota:</strong> Una vez finalizada la lotería, no se podrán realizar más cambios.
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                    <i class="fas fa-times"></i> Cancelar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remover modal existente si hay uno
            const existingModal = document.getElementById('finishOptionsModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Agregar modal al DOM
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // Mostrar modal
            const modal = new bootstrap.Modal(document.getElementById('finishOptionsModal'));
            modal.show();
        }

        // Seleccionar finalización manual
        async function selectManualFinish(lotteryId, force = false) {
            try {
                const token = localStorage.getItem('token');
                
                // Obtener tickets vendidos
                const ticketsResponse = await axios.get(`${API_BASE}/${lotteryId}/sold-tickets`, {
                    headers: { Authorization: `Bearer ${token}` }
                });
                
                const soldTickets = ticketsResponse.data.data.ticket_numbers;
                
                if (soldTickets.length === 0) {
                    showAlert('No hay tickets vendidos para esta lotería', 'warning');
                    closeModal('finishOptionsModal');
                    return;
                }
                
                // Cerrar modal de opciones
                closeModal('finishOptionsModal');
                
                // Mostrar modal de selección manual
                showManualSelectionModal(lotteryId, force, soldTickets);
                
            } catch (error) {
                console.error('Error al cargar tickets para selección manual:', error);
                showAlert('Error al cargar los tickets vendidos', 'danger');
            }
        }

        // Seleccionar finalización automática
        async function selectAutomaticFinish(lotteryId, force = false) {
            try {
                // Obtener información de la lotería
                const token = localStorage.getItem('token');
                const lotteryResponse = await axios.get(`${API_BASE}/${lotteryId}`, {
                    headers: { Authorization: `Bearer ${token}` }
                });
                
                const lottery = lotteryResponse.data.data;
                
                // Cerrar modal de opciones
                closeModal('finishOptionsModal');
                
                // Confirmar selección automática
                const confirmAuto = confirm(`¿Confirmas finalizar la lotería con selección automática de ganadores?

El sistema seleccionará ${lottery.num_winners} ganador${lottery.num_winners > 1 ? 'es' : ''} al azar entre todos los tickets vendidos.

¿Deseas continuar?`);
                
                if (confirmAuto) {
                    await performLotteryFinish(lotteryId, { 
                        force,
                        winner_selection_method: 'random',
                        winning_numbers: []
                    });
                }
            } catch (error) {
                console.error('Error al obtener información de la lotería:', error);
                showAlert('Error al obtener información de la lotería', 'danger');
            }
        }

        // Mostrar modal de selección manual
        function showManualSelectionModal(lotteryId, force, soldTickets) {
            // Obtener información de la lotería para mostrar en el modal
            axios.get(`${API_BASE}/${lotteryId}`, {
                headers: { Authorization: `Bearer ${localStorage.getItem('token')}` }
            }).then(response => {
                const lottery = response.data.data;
                
                // Crear modal de selección manual
                const modalHtml = `
                    <div class="modal fade" id="manualSelectionModal" tabindex="-1">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header bg-primary text-white">
                                    <h5 class="modal-title">
                                        <i class="fas fa-hand-pointer"></i> 
                                        Selección Manual de Ganadores: ${lottery.title}
                                    </h5>
                                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="mb-4">
                                        <h6 class="fw-bold">📊 Información:</h6>
                                        <ul class="list-unstyled">
                                            <li><strong>Tickets vendidos:</strong> ${lottery.tickets_sold}</li>
                                            <li><strong>Ganadores a seleccionar:</strong> ${lottery.num_winners}</li>
                                            <li><strong>Números disponibles:</strong> ${soldTickets.length}</li>
                                        </ul>
                                    </div>
                                    
                                    <div class="mb-4">
                                        <h6 class="fw-bold">🎫 Selecciona los números ganadores (${lottery.num_winners} ganador${lottery.num_winners > 1 ? 'es' : ''}):</h6>
                                        <div class="alert alert-info">
                                            <i class="fas fa-info-circle"></i> 
                                            Haz clic en los números para seleccionar los ganadores. 
                                            Puedes seleccionar hasta ${lottery.num_winners} número${lottery.num_winners > 1 ? 's' : ''}.
                                        </div>
                                        <div id="ticketNumbers" class="d-flex flex-wrap gap-2" style="max-height: 300px; overflow-y: auto;">
                                            ${soldTickets.map(num => `
                                                <button type="button" class="btn btn-outline-primary ticket-number-btn" data-number="${num}">
                                                    ${num}
                                                </button>
                                            `).join('')}
                                        </div>
                                        <div class="mt-3">
                                            <strong>Números seleccionados:</strong>
                                            <span id="selectedNumbers" class="text-primary">Ninguno</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                        <i class="fas fa-times"></i> Cancelar
                                    </button>
                                    <button type="button" class="btn btn-success" id="confirmManualFinishBtn">
                                        <i class="fas fa-trophy"></i> Finalizar con Selección Manual
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Remover modal existente si hay uno
                const existingModal = document.getElementById('manualSelectionModal');
                if (existingModal) {
                    existingModal.remove();
                }
                
                // Agregar modal al DOM
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                
                // Configurar eventos del modal
                setupManualSelectionModal(lotteryId, lottery, force, soldTickets);
                
                // Mostrar modal
                const modal = new bootstrap.Modal(document.getElementById('manualSelectionModal'));
                modal.show();
                
            }).catch(error => {
                console.error('Error al cargar información de lotería:', error);
                showAlert('Error al cargar información de la lotería', 'danger');
            });
        }

        // Configurar eventos del modal de selección manual
        function setupManualSelectionModal(lotteryId, lottery, force, soldTickets) {
            const modal = document.getElementById('manualSelectionModal');
            const confirmBtn = modal.querySelector('#confirmManualFinishBtn');
            const selectedNumbersSpan = modal.querySelector('#selectedNumbers');
            
            let selectedNumbers = [];
            
            // Función para actualizar números seleccionados
            function updateSelectedNumbers() {
                if (selectedNumbers.length === 0) {
                    selectedNumbersSpan.textContent = 'Ninguno';
                    selectedNumbersSpan.className = 'text-muted';
                } else {
                    selectedNumbersSpan.textContent = selectedNumbers.sort((a, b) => a - b).join(', ');
                    selectedNumbersSpan.className = 'text-primary fw-bold';
                }
                
                // Actualizar estado del botón confirmar
                const isValidSelection = selectedNumbers.length === lottery.num_winners;
                confirmBtn.disabled = !isValidSelection;
                
                if (selectedNumbers.length !== lottery.num_winners) {
                    confirmBtn.innerHTML = `
                        <i class="fas fa-exclamation-triangle"></i> 
                        Selecciona ${lottery.num_winners} número${lottery.num_winners > 1 ? 's' : ''} 
                        (${selectedNumbers.length}/${lottery.num_winners})
                    `;
                } else {
                    confirmBtn.innerHTML = '<i class="fas fa-trophy"></i> Finalizar con Selección Manual';
                }
            }
            
            // Event listeners para los botones de números
            modal.querySelectorAll('.ticket-number-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const number = parseInt(btn.dataset.number);
                    
                    if (selectedNumbers.includes(number)) {
                        // Deseleccionar
                        selectedNumbers = selectedNumbers.filter(n => n !== number);
                        btn.classList.remove('btn-success');
                        btn.classList.add('btn-outline-primary');
                    } else {
                        // Seleccionar si no se ha alcanzado el límite
                        if (selectedNumbers.length < lottery.num_winners) {
                            selectedNumbers.push(number);
                            btn.classList.remove('btn-outline-primary');
                            btn.classList.add('btn-success');
                        } else {
                            showAlert(`Solo puedes seleccionar ${lottery.num_winners} ganador${lottery.num_winners > 1 ? 'es' : ''}`, 'warning');
                        }
                    }
                    
                    updateSelectedNumbers();
                });
            });
            
            // Confirmar finalización manual
            confirmBtn.addEventListener('click', async () => {
                // Cerrar modal
                const modalInstance = bootstrap.Modal.getInstance(modal);
                modalInstance.hide();
                
                // Finalizar lotería con selección manual
                await performLotteryFinish(lotteryId, { 
                    force,
                    winner_selection_method: 'manual',
                    winning_numbers: selectedNumbers
                });
            });
            
            // Inicializar estado
            updateSelectedNumbers();
        }

        // Mostrar modal de selección de ganadores
        async function showWinnerSelectionModal(lotteryId, lottery, force = false) {
            try {
                const token = localStorage.getItem('token');
                
                // Obtener tickets vendidos
                const ticketsResponse = await axios.get(`${API_BASE}/${lotteryId}/sold-tickets`, {
                    headers: { Authorization: `Bearer ${token}` }
                });
                
                const soldTickets = ticketsResponse.data.data.ticket_numbers;
                
                if (soldTickets.length === 0) {
                    showAlert('No hay tickets vendidos para esta lotería', 'warning');
                    return;
                }
                
                // Crear modal de selección
                const modalHtml = `
                    <div class="modal fade" id="winnerSelectionModal" tabindex="-1">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">
                                        <i class="fas fa-trophy"></i> 
                                        Finalizar Lotería: ${lottery.title}
                                    </h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="mb-4">
                                        <h6 class="fw-bold">📊 Información de la Lotería:</h6>
                                        <ul class="list-unstyled">
                                            <li><strong>Tickets vendidos:</strong> ${lottery.tickets_sold}</li>
                                            <li><strong>Ganadores a seleccionar:</strong> ${lottery.num_winners}</li>
                                            <li><strong>Estado:</strong> ${lottery.status}</li>
                                        </ul>
                                    </div>
                                    
                                    <div class="mb-4">
                                        <h6 class="fw-bold">🎯 Método de Selección:</h6>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="radio" name="selectionMethod" id="randomSelection" value="random" checked>
                                            <label class="form-check-label" for="randomSelection">
                                                <i class="fas fa-random"></i> <strong>Selección Aleatoria</strong>
                                                <small class="text-muted d-block">El sistema seleccionará los ganadores al azar</small>
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="selectionMethod" id="manualSelection" value="manual">
                                            <label class="form-check-label" for="manualSelection">
                                                <i class="fas fa-hand-pointer"></i> <strong>Selección Manual</strong>
                                                <small class="text-muted d-block">Tú elegirás los números ganadores</small>
                                            </label>
                                        </div>
                                    </div>
                                    
                                    <div id="manualSelectionArea" class="mb-4" style="display: none;">
                                        <h6 class="fw-bold">🎫 Seleccionar Números Ganadores (${lottery.num_winners} ganador${lottery.num_winners > 1 ? 'es' : ''}):</h6>
                                        <div class="alert alert-info">
                                            <i class="fas fa-info-circle"></i> 
                                            Haz clic en los números para seleccionar los ganadores. 
                                            Puedes seleccionar hasta ${lottery.num_winners} número${lottery.num_winners > 1 ? 's' : ''}.
                                        </div>
                                        <div id="ticketNumbers" class="d-flex flex-wrap gap-2">
                                            ${soldTickets.map(num => `
                                                <button type="button" class="btn btn-outline-primary ticket-number-btn" data-number="${num}">
                                                    ${num}
                                                </button>
                                            `).join('')}
                                        </div>
                                        <div class="mt-3">
                                            <strong>Números seleccionados:</strong>
                                            <span id="selectedNumbers" class="text-primary">Ninguno</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                        <i class="fas fa-times"></i> Cancelar
                                    </button>
                                    <button type="button" class="btn btn-success" id="confirmFinishBtn">
                                        <i class="fas fa-trophy"></i> Finalizar Lotería
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Remover modal existente si hay uno
                const existingModal = document.getElementById('winnerSelectionModal');
                if (existingModal) {
                    existingModal.remove();
                }
                
                // Agregar modal al DOM
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                
                // Configurar eventos del modal
                setupWinnerSelectionModal(lotteryId, lottery, force, soldTickets);
                
                // Mostrar modal
                const modal = new bootstrap.Modal(document.getElementById('winnerSelectionModal'));
                modal.show();
                
            } catch (error) {
                console.error('Error mostrando modal de selección:', error);
                showAlert('Error al cargar opciones de selección de ganadores', 'danger');
            }
        }

        // Configurar eventos del modal de selección
        function setupWinnerSelectionModal(lotteryId, lottery, force, soldTickets) {
            const modal = document.getElementById('winnerSelectionModal');
            const randomRadio = modal.querySelector('#randomSelection');
            const manualRadio = modal.querySelector('#manualSelection');
            const manualArea = modal.querySelector('#manualSelectionArea');
            const confirmBtn = modal.querySelector('#confirmFinishBtn');
            const selectedNumbersSpan = modal.querySelector('#selectedNumbers');
            
            let selectedNumbers = [];
            
            // Manejar cambio de método de selección
            function handleSelectionMethodChange() {
                if (manualRadio.checked) {
                    manualArea.style.display = 'block';
                } else {
                    manualArea.style.display = 'none';
                    selectedNumbers = [];
                    updateSelectedNumbers();
                }
            }
            
            randomRadio.addEventListener('change', handleSelectionMethodChange);
            manualRadio.addEventListener('change', handleSelectionMethodChange);
            
            // Manejar selección de números
            function updateSelectedNumbers() {
                if (selectedNumbers.length === 0) {
                    selectedNumbersSpan.textContent = 'Ninguno';
                    selectedNumbersSpan.className = 'text-muted';
                } else {
                    selectedNumbersSpan.textContent = selectedNumbers.sort((a, b) => a - b).join(', ');
                    selectedNumbersSpan.className = 'text-primary fw-bold';
                }
                
                // Actualizar estado del botón confirmar
                const isValidSelection = randomRadio.checked || selectedNumbers.length === lottery.num_winners;
                confirmBtn.disabled = !isValidSelection;
                
                if (manualRadio.checked && selectedNumbers.length !== lottery.num_winners) {
                    confirmBtn.innerHTML = `
                        <i class="fas fa-exclamation-triangle"></i> 
                        Selecciona ${lottery.num_winners} número${lottery.num_winners > 1 ? 's' : ''} 
                        (${selectedNumbers.length}/${lottery.num_winners})
                    `;
                } else {
                    confirmBtn.innerHTML = '<i class="fas fa-trophy"></i> Finalizar Lotería';
                }
            }
            
            // Event listeners para los botones de números
            modal.querySelectorAll('.ticket-number-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const number = parseInt(btn.dataset.number);
                    
                    if (selectedNumbers.includes(number)) {
                        // Deseleccionar
                        selectedNumbers = selectedNumbers.filter(n => n !== number);
                        btn.classList.remove('btn-success');
                        btn.classList.add('btn-outline-primary');
                    } else {
                        // Seleccionar si no se ha alcanzado el límite
                        if (selectedNumbers.length < lottery.num_winners) {
                            selectedNumbers.push(number);
                            btn.classList.remove('btn-outline-primary');
                            btn.classList.add('btn-success');
                        } else {
                            showAlert(`Solo puedes seleccionar ${lottery.num_winners} ganador${lottery.num_winners > 1 ? 'es' : ''}`, 'warning');
                        }
                    }
                    
                    updateSelectedNumbers();
                });
            });
            
            // Confirmar finalización
            confirmBtn.addEventListener('click', async () => {
                const method = manualRadio.checked ? 'manual' : 'random';
                const winningNumbers = method === 'manual' ? selectedNumbers : [];
                
                // Cerrar modal
                const modalInstance = bootstrap.Modal.getInstance(modal);
                modalInstance.hide();
                
                // Finalizar lotería
                await performLotteryFinish(lotteryId, { 
                    force,
                    winner_selection_method: method,
                    winning_numbers: winningNumbers
                });
            });
            
            // Inicializar estado
            updateSelectedNumbers();
        }

        // Realizar finalización de lotería
        async function performLotteryFinish(lotteryId, params) {
            try {
                const token = localStorage.getItem('token');
                
                const response = await axios.post(`${API_BASE}/${lotteryId}/finish`, params, {
                    headers: { Authorization: `Bearer ${token}` }
                });

                if (response.data.data.status === 'cancelled') {
                    showAlert(`Lotería cancelada: ${response.data.message}`, 'warning');
                } else {
                    const selectionText = params.winner_selection_method === 'manual' ? 'manualmente' : 'aleatoriamente';
                    showAlert(`¡Lotería finalizada exitosamente! Ganadores seleccionados ${selectionText}: ${response.data.data.winners_count}`, 'success');
                }
                
                loadLotteries(currentPage);
                updateStats();
                
            } catch (error) {
                console.error('Error al finalizar lotería:', error);
                showAlert(`Error al finalizar la lotería: ${error.response?.data?.message || error.message}`, 'danger');
            }
        }

        // Cancelar lotería
        async function cancelLottery(lotteryId) {
            if (!confirm('¿Estás seguro de que quieres cancelar esta lotería? Se procesarán reembolsos automáticamente.')) return;
            
            try {
                const token = localStorage.getItem('token');
                const response = await axios.put(`${API_BASE}/${lotteryId}/cancel`, {}, {
                    headers: { Authorization: `Bearer ${token}` }
                });

                const refundedTickets = response.data.data.refunded_tickets;
                const message = refundedTickets > 0 
                    ? `Lotería cancelada exitosamente. Se procesaron ${refundedTickets} reembolsos.`
                    : 'Lotería cancelada exitosamente.';
                
                showAlert(message, 'success');
                loadLotteries(currentPage);
                updateStats();
            } catch (error) {
                console.error('Error al cancelar lotería:', error);
                showAlert(error.response?.data?.message || 'Error al cancelar la lotería', 'danger');
            }
        }

        // Eliminar lotería
        async function deleteLottery(lotteryId) {
            try {
                // Primero obtener información de la lotería para verificar si tiene tickets vendidos
                const token = localStorage.getItem('token');
                const lotteryResponse = await axios.get(`${API_BASE}/${lotteryId}`, {
                    headers: { Authorization: `Bearer ${token}` }
                });
                
                const lottery = lotteryResponse.data.data;
                const hasTicketsSold = lottery.tickets_sold > 0;
                
                let confirmMessage;
                if (hasTicketsSold) {
                    confirmMessage = `⚠️ ADVERTENCIA: Esta lotería tiene ${lottery.tickets_sold} tickets vendidos.\n\n` +
                                   `Al eliminarla se perderán TODOS los datos incluyendo:\n` +
                                   `• ${lottery.tickets_sold} tickets de usuarios\n` +
                                   `• Historial de participación\n` +
                                   `• Posibles ganadores\n\n` +
                                   `¿Estás COMPLETAMENTE SEGURO de que quieres eliminar "${lottery.title}"?\n\n` +
                                   `Esta acción NO SE PUEDE DESHACER.`;
                } else {
                    confirmMessage = `¿Estás seguro de que quieres eliminar la lotería "${lottery.title}"?\n\n` +
                                   `Esta acción no se puede deshacer.`;
                }
                
                if (!confirm(confirmMessage)) return;
                
                // Si tiene tickets vendidos, pedir confirmación adicional
                if (hasTicketsSold) {
                    const finalConfirm = prompt(
                        `Para confirmar que entiendes las consecuencias, escribe: ELIMINAR\n\n` +
                        `(Se eliminarán ${lottery.tickets_sold} tickets vendidos)`
                    );
                    
                    if (finalConfirm !== 'ELIMINAR') {
                        showAlert('Eliminación cancelada', 'info');
                        return;
                    }
                }
                
                const response = await axios.delete(`${API_BASE}/${lotteryId}`, {
                    headers: { Authorization: `Bearer ${token}` }
                });

                const deletedTickets = response.data.data.deleted_tickets || 0;
                let message = response.data.message;
                
                if (deletedTickets > 0) {
                    message += ` ⚠️ Se eliminaron ${deletedTickets} tickets de usuarios.`;
                }
                
                showAlert(message, deletedTickets > 0 ? 'warning' : 'success');
                loadLotteries(currentPage);
                updateStats();
                
            } catch (error) {
                console.error('Error al eliminar lotería:', error);
                showAlert(error.response?.data?.message || 'Error al eliminar la lotería', 'danger');
            }
        }

        // Editar lotería
        async function editLottery(lotteryId) {
            try {
                const token = localStorage.getItem('token');
                const response = await axios.get(`${API_BASE}/${lotteryId}`, {
                    headers: { Authorization: `Bearer ${token}` }
                });

                const lottery = response.data.data;
                
                // Verificar que la lotería puede ser editada (draft, cancelled o active)
                if (!['draft', 'cancelled', 'active'].includes(lottery.status)) {
                    showAlert('Solo se pueden editar loterías en estado borrador, canceladas o activas', 'warning');
                    return;
                }
                
                // Advertencia especial para loterías activas con tickets vendidos
                if (lottery.status === 'active' && lottery.tickets_sold > 0) {
                    const proceedEdit = confirm(`⚠️ ADVERTENCIA: Esta lotería está ACTIVA y tiene ${lottery.tickets_sold} tickets vendidos.
                    
Al editarla, solo podrás modificar:
• Título y descripción
• Imagen
• Fechas de inicio y fin
• Descripción del premio
• Términos y condiciones

NO podrás cambiar:
• Precio de tickets
• Cantidad máxima/mínima de tickets
• Número de ganadores
• Si es gratis o de pago

¿Deseas continuar con la edición?`);
                    
                    if (!proceedEdit) {
                        return;
                    }
                }
                
                // Llenar el formulario con los datos existentes
                currentLotteryId = lotteryId;
                document.getElementById('lotteryModalTitle').textContent = 'Editar Lotería';
                
                document.getElementById('title').value = lottery.title || '';
                document.getElementById('description').value = lottery.description || '';
                document.getElementById('is_free').value = lottery.is_free ? 'true' : 'false';
                document.getElementById('ticket_price').value = lottery.ticket_price || 0;
                document.getElementById('min_tickets').value = lottery.min_tickets || 1;
                document.getElementById('max_tickets').value = lottery.max_tickets || 100;
                document.getElementById('num_winners').value = lottery.num_winners || 1;
                
                // Formatear fechas para el input datetime-local
                const startDate = new Date(lottery.start_date);
                const endDate = new Date(lottery.end_date);
                document.getElementById('start_date').value = formatDateTimeLocal(startDate);
                document.getElementById('end_date').value = formatDateTimeLocal(endDate);
                
                // Los campos prize_description y terms_conditions fueron eliminados
                
                // Deshabilitar campos restringidos para loterías activas con tickets vendidos
                const isActiveWithTickets = lottery.status === 'active' && lottery.tickets_sold > 0;
                const restrictedFields = ['is_free', 'ticket_price', 'min_tickets', 'max_tickets', 'num_winners'];
                
                restrictedFields.forEach(fieldId => {
                    const element = document.getElementById(fieldId);
                    if (element) {
                        element.disabled = isActiveWithTickets;
                        if (isActiveWithTickets) {
                            element.style.backgroundColor = '#f8f9fa';
                            element.style.cursor = 'not-allowed';
                            element.title = 'No se puede modificar en loterías activas con tickets vendidos';
                        } else {
                            element.disabled = false;
                            element.style.backgroundColor = '';
                            element.style.cursor = '';
                            element.title = '';
                        }
                    }
                });
                
                // Actualizar título del modal si es lotería activa con restricciones
                if (isActiveWithTickets) {
                    document.getElementById('lotteryModalTitle').textContent = `Editar Lotería Activa (${lottery.tickets_sold} tickets vendidos)`;
                }
                
                // Mostrar el modal
                new bootstrap.Modal(document.getElementById('lotteryModal')).show();
                
            } catch (error) {
                console.error('Error al cargar lotería para editar:', error);
                showAlert('Error al cargar los datos de la lotería', 'danger');
            }
        }

        // Reanudar lotería cancelada
        async function resumeLottery(lotteryId) {
            try {
                const token = localStorage.getItem('token');
                
                // Obtener datos de la lotería para mostrar información
                const lotteryResponse = await axios.get(`${API_BASE}/${lotteryId}`, {
                    headers: { Authorization: `Bearer ${token}` }
                });
                
                const lottery = lotteryResponse.data.data;
                
                // Verificar que la lotería está cancelada
                if (lottery.status !== 'cancelled') {
                    showAlert('Solo se pueden reanudar loterías canceladas', 'warning');
                    return;
                }
                
                // Preguntar al usuario el nuevo estado
                const resumeOptions = `¿Cómo quieres reanudar la lotería "${lottery.title}"?

Opciones:
1 - Como BORRADOR (podrás editarla antes de activar)
2 - Como ACTIVA (usuarios podrán participar inmediatamente)

Escribe 1 o 2:`;
                
                const choice = prompt(resumeOptions);
                
                if (!choice || !['1', '2'].includes(choice)) {
                    showAlert('Reanudación cancelada', 'info');
                    return;
                }
                
                const newStatus = choice === '1' ? 'draft' : 'active';
                const statusText = choice === '1' ? 'borrador' : 'activa';
                
                // Confirmar la acción
                const confirmMessage = `¿Confirmas reanudar la lotería como ${statusText.toUpperCase()}?

Lotería: ${lottery.title}
Estado actual: Cancelada
Nuevo estado: ${statusText}

Los tickets que fueron reembolsados NO se restaurarán automáticamente.`;
                
                if (!confirm(confirmMessage)) return;
                
                // Hacer la petición para cambiar el estado
                const response = await axios.put(`${API_BASE}/${lotteryId}`, {
                    status: newStatus
                }, {
                    headers: { Authorization: `Bearer ${token}` }
                });
                
                showAlert(`Lotería reanudada como ${statusText} exitosamente`, 'success');
                loadLotteries(currentPage);
                updateStats();
                
            } catch (error) {
                console.error('Error al reanudar lotería:', error);
                showAlert(error.response?.data?.message || 'Error al reanudar la lotería', 'danger');
            }
        }

        // Ver ganadores
        async function viewWinners(lotteryId) {
            try {
                const token = localStorage.getItem('token');
                const response = await axios.get(`${API_BASE}/${lotteryId}/winners`, {
                    headers: { Authorization: `Bearer ${token}` }
                });

                const winners = response.data.data;
                const modalBody = document.getElementById('detailsModalBody');
                
                if (winners.length === 0) {
                    modalBody.innerHTML = `
                        <div class="text-center py-4">
                            <i class="fas fa-trophy fa-3x text-muted mb-3"></i>
                            <h5>No hay ganadores seleccionados</h5>
                            <p class="text-muted">Los ganadores se seleccionarán cuando la lotería finalice</p>
                        </div>
                    `;
                } else {
                    let winnersHtml = '<h5>Ganadores</h5><div class="row">';
                    winners.forEach(winner => {
                        winnersHtml += `
                            <div class="col-md-6 mb-3">
                                <div class="card border-success">
                                    <div class="card-body">
                                        <h6 class="card-title">
                                            <i class="fas fa-trophy text-success"></i> 
                                            Ticket #${winner.ticket_number}
                                        </h6>
                                        <p class="card-text">
                                            <strong>Usuario:</strong> ${winner.username}<br>
                                            <strong>Email:</strong> ${winner.email}<br>
                                            <strong>Premio:</strong> ${winner.prize_description || 'No especificado'}
                                        </p>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    winnersHtml += '</div>';
                    modalBody.innerHTML = winnersHtml;
                }
                
                new bootstrap.Modal(document.getElementById('detailsModal')).show();
            } catch (error) {
                console.error('Error al cargar ganadores:', error);
                showAlert('Error al cargar los ganadores', 'danger');
            }
        }

        // Verificar loterías vencidas
        async function checkOverdueLotteries() {
            try {
                const token = localStorage.getItem('token');
                const response = await axios.get(`${API_BASE}?status=active`, {
                    headers: { Authorization: `Bearer ${token}` }
                });

                const overdueLotteries = response.data.data.filter(l => l.current_status === 'overdue');
                
                if (overdueLotteries.length === 0) {
                    showAlert('No hay loterías vencidas', 'info');
                } else {
                    showAlert(`Hay ${overdueLotteries.length} lotería(s) vencida(s) que requieren finalización`, 'warning');
                }
            } catch (error) {
                console.error('Error al verificar loterías vencidas:', error);
                showAlert('Error al verificar loterías vencidas', 'danger');
            }
        }

        // Refrescar loterías
        function refreshLotteries() {
            loadLotteries(currentPage);
            updateStats();
        }

        // Generar reporte
        async function generateReport(lotteryId) {
            try {
                const token = localStorage.getItem('token');
                const response = await axios.get(`${API_BASE}/${lotteryId}`, {
                    headers: { Authorization: `Bearer ${token}` }
                });

                const lottery = response.data.data;
                
                // Crear reporte simple
                const report = `
                    REPORTE DE LOTERÍA
                    ==================
                    Título: ${lottery.title}
                    Estado: ${getStatusText(lottery.current_status || lottery.status)}
                    Tickets vendidos: ${lottery.tickets_sold || 0}/${lottery.max_tickets}
                    Participación: ${Math.round((lottery.tickets_sold || 0) / lottery.max_tickets * 100)}%
                    Ganadores: ${lottery.winners_selected || 0}/${lottery.num_winners}
                    Fecha de fin: ${formatDate(lottery.end_date)}
                `;
                
                // Crear archivo de descarga
                const blob = new Blob([report], { type: 'text/plain' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `reporte-loteria-${lotteryId}.txt`;
                a.click();
                window.URL.revokeObjectURL(url);
                
                showAlert('Reporte descargado exitosamente', 'success');
            } catch (error) {
                console.error('Error al generar reporte:', error);
                showAlert('Error al generar el reporte', 'danger');
            }
        }

        // Configurar campo de precio según tipo de lotería
        function setupPriceField() {
            const isFreeSelect = document.getElementById('is_free');
            const priceContainer = document.getElementById('priceFieldContainer');
            const priceInput = document.getElementById('ticket_price');
            
            if (isFreeSelect.value === 'true') {
                // Lotería gratuita
                priceContainer.style.display = 'none';
                priceInput.required = false;
                priceInput.value = '0';
            } else {
                // Lotería de pago
                priceContainer.style.display = 'block';
                priceInput.required = true;
                priceInput.value = '100';
            }
        }

        // Event listener para cambio de tipo de lotería
        document.addEventListener('DOMContentLoaded', function() {
            const isFreeSelect = document.getElementById('is_free');
            if (isFreeSelect) {
                isFreeSelect.addEventListener('change', setupPriceField);
            }
        });

        // Funciones auxiliares
        function getStatusClass(status) {
            const classes = {
                'draft': 'bg-secondary',
                'active': 'bg-primary',
                'running': 'bg-success',
                'pending': 'bg-warning',
                'overdue': 'bg-danger',
                'closed': 'bg-dark',
                'finished': 'bg-success',
                'cancelled': 'bg-danger'
            };
            return classes[status] || 'bg-secondary';
        }

        function getStatusText(status) {
            const texts = {
                'draft': 'Borrador',
                'active': 'Activa',
                'running': 'En curso',
                'pending': 'Pendiente',
                'overdue': 'Vencida',
                'closed': 'Cerrada',
                'finished': 'Finalizada',
                'cancelled': 'Cancelada'
            };
            return texts[status] || status;
        }

        function formatDate(dateString) {
            return new Date(dateString).toLocaleString('es-ES');
        }

        function formatDateTimeLocal(date) {
            const d = new Date(date);
            return d.toISOString().slice(0, 16);
        }

        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }

        // Funciones de utilidad para modales
        function closeModal(modalId) {
            try {
                const modalElement = document.getElementById(modalId);
                const modalInstance = bootstrap.Modal.getInstance(modalElement);
                
                if (modalInstance) {
                    modalInstance.hide();
                }
                
                // Limpiar backdrop si se queda colgado
                setTimeout(() => {
                    const backdrops = document.querySelectorAll('.modal-backdrop');
                    backdrops.forEach(backdrop => backdrop.remove());
                    
                    // Restaurar scroll del body
                    document.body.classList.remove('modal-open');
                    document.body.style.overflow = '';
                    document.body.style.paddingRight = '';
                    
                    // Limpiar aria-hidden
                    modalElement.setAttribute('aria-hidden', 'true');
                    modalElement.style.display = 'none';
                }, 300);
                
            } catch (error) {
                console.error('Error cerrando modal:', error);
                // Forzar limpieza si hay error
                forceCloseAllModals();
            }
        }

        function forceCloseAllModals() {
            // Limpiar todos los backdrops
            document.querySelectorAll('.modal-backdrop').forEach(backdrop => backdrop.remove());
            
            // Limpiar todos los modales
            document.querySelectorAll('.modal').forEach(modal => {
                modal.style.display = 'none';
                modal.setAttribute('aria-hidden', 'true');
                modal.classList.remove('show');
            });
            
            // Restaurar body
            document.body.classList.remove('modal-open');
            document.body.style.overflow = '';
            document.body.style.paddingRight = '';
        }

        // Limpiar modales al cargar la página
        window.addEventListener('load', () => {
            forceCloseAllModals();
            
            // Agregar listeners para limpiar modales cuando se cierren
            const modals = ['lotteryModal', 'detailsModal'];
            modals.forEach(modalId => {
                const modalElement = document.getElementById(modalId);
                if (modalElement) {
                    modalElement.addEventListener('hidden.bs.modal', () => {
                        setTimeout(() => {
                            forceCloseAllModals();
                        }, 100);
                    });
                }
            });
        });

        function logout() {
            localStorage.removeItem('token');
            window.location.href = '/login.html';
        }

        // === DASHBOARD FUNCTIONS ===
        
        // Theme toggle functionality
        document.addEventListener('DOMContentLoaded', function() {
            const themeToggle = document.getElementById('themeToggle');
            const body = document.body;
            
            // Load saved theme
            const savedTheme = localStorage.getItem('theme') || 'dark';
            body.setAttribute('data-theme', savedTheme);
            themeToggle.checked = savedTheme === 'light';
            
            // Theme toggle event
            themeToggle.addEventListener('change', function() {
                const newTheme = this.checked ? 'light' : 'dark';
                body.setAttribute('data-theme', newTheme);
                localStorage.setItem('theme', newTheme);
            });
            
            // Mobile menu functionality
            const mobileMenuBtn = document.getElementById('mobileMenuBtn');
            const sidebar = document.getElementById('sidebar');
            const mobileOverlay = document.getElementById('mobileOverlay');
            
            mobileMenuBtn.addEventListener('click', function() {
                sidebar.classList.toggle('open');
                mobileOverlay.classList.toggle('show');
            });
            
            mobileOverlay.addEventListener('click', function() {
                sidebar.classList.remove('open');
                mobileOverlay.classList.remove('show');
            });
            
            // Logout functionality
            const logoutBtn = document.getElementById('logoutBtn');
            logoutBtn.addEventListener('click', function() {
                localStorage.removeItem('token');
                window.location.href = '/login.html';
            });
            
            // Check authentication
            checkAuth();
        });
        
        // Check authentication function
        async function checkAuth() {
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    window.location.href = '/login.html';
                    return;
                }

                const response = await axios.get('/api/v1/auth/me', {
                    headers: { Authorization: `Bearer ${token}` }
                });

                if (response.data.user.rol !== 'administrador') {
                    alert('Acceso denegado. Solo administradores pueden acceder.');
                    window.location.href = '/dashboard.html';
                    return;
                }

                // Update username in top bar
                const usernameElement = document.querySelector('.top-bar-actions');
                if (usernameElement) {
                    const userSpan = document.createElement('span');
                    userSpan.className = 'me-3 text-muted';
                    userSpan.innerHTML = `<i class="bi bi-person"></i> ${response.data.user.nombre}`;
                    usernameElement.insertBefore(userSpan, usernameElement.firstChild);
                }
            } catch (error) {
                console.error('Error de autenticación:', error);
                window.location.href = '/login.html';
            }
        }
        
        // Event listeners para filtros
        document.getElementById('statusFilter').addEventListener('change', () => loadLotteries(1));
        document.getElementById('typeFilter').addEventListener('change', () => loadLotteries(1));
        
        // Event listener para cambio de tipo de lotería en el modal
        document.addEventListener('DOMContentLoaded', function() {
            const isFreeSelect = document.getElementById('is_free');
            if (isFreeSelect) {
                isFreeSelect.addEventListener('change', setupPriceField);
            }
        });
    </script>
</body>
</html> 